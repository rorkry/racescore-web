# 展開予想カード 仕様書

**作成日**: 2026年1月4日  
**最終更新**: 2026年1月4日  
**バージョン**: v4.0（最大前進制限追加版）  
**主要ファイル**: 
- `app/components/CourseStyleRacePace.tsx`（表示ロジック）
- `lib/race-pace-predictor.ts`（予想ロジック）

---

## 📋 目次

1. [概要](#概要)
2. [v4.0の主要変更点](#v40の主要変更点)
3. [使用データ](#使用データ)
4. [展開予想の計算ロジック](#展開予想の計算ロジック)
5. [スタート後の位置予想](#スタート後の位置予想)
6. [ゴール前の位置予想](#ゴール前の位置予想)
7. [視覚化の仕様](#視覚化の仕様)
8. [来る可能性が高い馬の判定](#来る可能性が高い馬の判定)
9. [馬群グルーピング](#馬群グルーピング)
10. [バイアス設定](#バイアス設定)

---

## 概要

展開予想カードは、レースの想定ペースと各馬の脚質・過去実績から、**スタート後（2コーナー）** と **ゴール前** の位置関係を可視化します。

### 主な特徴
- ✅ **脚質別の位置予想**（逃げ・先行・差し・追込）
- ✅ **ペース分析**（スロー・ミドル・ハイ）
- ✅ **コース特性の考慮**（枠の有利不利、坂の有無、直線距離）
- ✅ **競うスコアとの連携**（実力評価）
- ✅ **スコア別の最大前進制限**（過大評価防止）
- ✅ **馬群の自然なグループ化**（4-5グループ程度）
- ✅ **大敗続き馬の検出と後退**
- ✅ **バイアス設定による微調整**

---

## v4.0の主要変更点

### 🆕 1. スコア別の最大前進制限

**目的**: 低スコア馬が展開だけで過度に浮上するのを防ぐ

```typescript
const maxAdvanceByScore = {
  0点: 0馬身,      // データなしは前進不可
  1-20点: 1.5馬身,
  21-30点: 2.5馬身,
  31-40点: 3.5馬身,
  41-50点: 4.5馬身,
  51-60点: 6.0馬身,
  61-70点: 8.0馬身,
  71-100点: 10.0馬身
};
```

**具体例**:
- スコア25点の馬がスタート10番手 → 最大でも7.5番手まで（2.5馬身制限）
- スコア65点の馬がスタート12番手 → 4番手まで浮上可能（8.0馬身制限）

### 🆕 2. ハイペース×差し馬の位置条件追加

**変更前**: スコア55以上なら脚質だけで恩恵
```typescript
if (runningStyle === 'sashi' && kisoScore >= 55) {
  adjustment -= 3.5; // 無条件で恩恵
}
```

**変更後**: スコア60以上 **かつ** 後方50%以上の位置
```typescript
if (runningStyle === 'sashi' && kisoScore >= 60 && startPosition / totalHorses >= 0.5) {
  adjustment -= 3.5; // 条件を満たして初めて恩恵
}
```

**理由**: 前方にいる差し馬はハイペースの恩恵を受けにくい

### 🆕 3. 大敗続き判定の厳格化

#### **1走のみの判定**
```typescript
if (records.length === 1 && timeDiffs[0] >= 3.0) {
  return true; // 3.0秒以上の大敗で即失速馬判定
}
```

#### **直近3走の平均着差**
```typescript
if (timeDiffs.length >= 3) {
  const avgDiff = timeDiffs.slice(0, 3).reduce((sum, d) => sum + d, 0) / 3;
  if (avgDiff >= 1.2) {  // 1.5秒 → 1.2秒に厳格化
    return true;
  }
}
```

---

## 使用データ

### 1. データベース（`umadata`テーブル）

| カラム名 | 用途 | 説明 |
|---------|------|------|
| `horse_name` | 馬の特定 | 過去走データの取得キー |
| `passing_ranks_2c` | 通過順位 | 2コーナーでの位置 |
| `front_2f_lap` | 前半2Fラップ | 位置取りの補正材料 |
| `distance` | 距離 | 短縮・延長の判定 |
| `finish_time` | 走破タイム | 大敗続き判定 |
| `standard_time` | 標準タイム | 大敗続き判定 |
| `finish_position` | 着順 | 大敗続き判定 |

### 2. データベース（`wakujun`テーブル）

| カラム名 | 用途 | 説明 |
|---------|------|------|
| `umamei` | 馬名 | 出走馬の特定 |
| `umaban` | 馬番 | 表示用 |
| `waku` | 枠番 | 枠の有利不利判定 |
| `kinryo` | 斤量 | 斤量補正 |

### 3. コース特性データ（`COURSE_CHARACTERISTICS`）

```typescript
export const COURSE_CHARACTERISTICS: Record<string, CourseCharacteristics> = {
  '東京_芝_1600': {
    straightLength: 525.9,
    hasSlope: true,
    slopePosition: 'finish',
    advantageousPosition: 'uchi-mae',
    cornerTightness: 'loose',
  },
  // ... 他のコース
};
```

### 4. 競うスコア（`kisouScores`）

```typescript
kisouScores: Record<number, number> = {
  1: 75.2,  // 馬番1番のスコア
  2: 62.8,  // 馬番2番のスコア
  // ...
}
```

---

## 展開予想の計算ロジック

### フロー

```
1. 過去走データ取得（直近5走）
   ↓
2. 脚質判定（通過順位の平均）
   ↓
3. スタート後位置の計算
   - 基本位置（過去平均）
   - 前半2Fラップによる補正
   - 距離の短縮・延長補正
   - 枠番補正
   ↓
4. 想定ペースの判定
   - 前半2Fラップの平均
   - コース特性
   - 逃げ馬の数
   ↓
5. ゴール前位置の計算
   - スタート位置から調整
   - 競うスコア
   - ペース適性
   - コース特性
   - 斤量
   - バイアス
   ↓
6. 視覚化
```

---

## スタート後の位置予想

### 1. 脚質判定（`lib/race-pace-predictor.ts` 272-299行目）

```typescript
function classifyRunningStyle(avgPosition: number, totalHorses: number): RunningStyle {
  const ratio = avgPosition / totalHorses;
  
  if (ratio <= 0.15) return 'escape';      // 逃げ：15%以内
  if (ratio <= 0.35) return 'lead';        // 先行：35%以内
  if (ratio <= 0.65) return 'sashi';       // 差し：65%以内
  return 'oikomi';                         // 追込：それ以外
}
```

| 脚質 | 条件 | 説明 |
|------|------|------|
| **逃げ** | 頭数の15%以内 | 18頭なら2.7番手以内 |
| **先行** | 頭数の35%以内 | 18頭なら6.3番手以内 |
| **差し** | 頭数の65%以内 | 18頭なら11.7番手以内 |
| **追込** | それ以上後方 | 18頭なら12番手以降 |

### 2. 基本位置の計算（`lib/race-pace-predictor.ts` 560-577行目）

```typescript
// データなし（過去走・ラップともゼロ件）の場合は最後方に固定配置
if (!hasPositionData && !hasLapData) {
  basePosition = horses.length + 2; // 末尾より後ろに固定
} else if (avgPosition !== null) {
  basePosition = avgPosition; // 過去平均位置
} else {
  basePosition = horses.length * 0.6; // 中団やや後ろ
}
```

### 3. 前半2Fラップによる補正（`lib/race-pace-predictor.ts` 580-612行目）

```typescript
// 前半2Fラップタイムによる調整
if (avgLapTime !== null && avgLapTimeDefined > 0) {
  // 最速馬より0.2秒以上速い → 先行力あり（前方へ）
  if (fastestLapTop10Threshold && avgLapTime <= fastestLapTop10Threshold - 0.2) {
    basePosition -= 2.5;
  }
  // 最速馬より0.1秒以上速い → やや先行力あり
  else if (fastestLapTop10Threshold && avgLapTime <= fastestLapTop10Threshold - 0.1) {
    basePosition -= 1.5;
  }
  // 最速馬と同等（±0.1秒）→ 位置キープ
  else if (fastestLapTop10Threshold && Math.abs(avgLapTime - fastestLapTop10Threshold) <= 0.1) {
    basePosition -= 0.0;
  }
  // 最速馬より0.2秒以上遅い → 後方へ
  else if (fastestLapTop10Threshold && avgLapTime >= fastestLapTop10Threshold + 0.2) {
    basePosition += 2.0;
  }
  // 最速馬より0.1秒以上遅い → やや後方へ
  else if (fastestLapTop10Threshold && avgLapTime >= fastestLapTop10Threshold + 0.1) {
    basePosition += 1.0;
  }
}
```

### 4. 距離の短縮・延長補正（`lib/race-pace-predictor.ts` 615-626行目）

```typescript
// 距離短縮・延長による補正
if (lastDistance !== null) {
  const distanceChange = trackDistance - lastDistance;
  
  if (distanceChange >= 400) {
    // 400m以上延長 → 差し・追込有利（前へ）
    if (runningStyle === 'sashi' || runningStyle === 'oikomi') basePosition -= 1.5;
  } else if (distanceChange <= -400) {
    // 400m以上短縮 → 逃げ・先行有利（前へ）
    if (runningStyle === 'escape' || runningStyle === 'lead') basePosition -= 1.0;
  }
}
```

### 5. 枠番補正（`lib/race-pace-predictor.ts` 238-446行目）

コース特性に応じて枠の有利不利を反映：

```typescript
function adjustPositionByCourseAndWaku(
  avgPosition2C: number | null,
  waku: string,
  totalHorses: number,
  place: string,
  distance: number,
  trackType: string
): number {
  const wakuNum = parseInt(waku, 10);
  const courseKey = `${place}_${trackType}_${distance}`;
  const courseChar = COURSE_CHARACTERISTICS[courseKey];
  
  // 例: 東京芝1600（内枠前有利）
  if (courseChar?.advantageousPosition === 'uchi-mae') {
    if (wakuNum <= 2) return avgPosition2C - 0.8; // 内枠は前へ
    if (wakuNum >= 7) return avgPosition2C + 0.5; // 外枠は後ろへ
  }
  
  // ...
}
```

---

## ゴール前の位置予想

### 計算式

```
ゴール前位置 = スタート後位置 + 総合調整値 + バイアス調整
```

### 総合調整値の内訳（`app/components/CourseStyleRacePace.tsx` 49-241行目）

#### 1. 競うスコアによる調整

| スコア範囲 | 調整値 | 不利要素 | 説明 |
|-----------|--------|---------|------|
| 0点 | +3.5 | 2個 | データなし→大きく後退 |
| 1-15点 | +6.0 | 3個 | 超極端に低い→最大級の後退 |
| 16-25点 | +4.5 | 2個 | 極端に低い→大きく後退 |
| 26-35点 | +3.0 | 1個 | 低い→後退 |
| 40-49点 | -1.0 | 0個 | やや有利→少し前進 |
| 50-59点 | -2.0 | 0個 | 中程度→前進 |
| 60-69点 | -3.5 | 0個（有利1個） | 上位→大きく前進 |
| 70点以上 | -5.0 | 0個（有利1個） | 本命→最大級の前進 |

#### 2. ペースによる調整（厳格化版）

##### **ハイペース**

| 条件 | スコア要件 | 調整値 | 有利要素 |
|------|----------|--------|---------|
| 差し・追込 | 55以上 | -3.5 | +1 |
| 差し・追込 | 45-54 | -2.0 | 0 |
| 差し・追込 | 35-44 | -0.8 | 0 |
| 差し・追込 | 35未満 | 0 | 0（恩恵なし） |
| 後方位置（60%以降） | 50以上 | -2.5 | +1 |
| 後方位置（60%以降） | 40-49 | -1.2 | 0 |
| 逃げ・先行（前方30%） | - | +2.5 | -1（不利） |

##### **スローペース**

| 条件 | スコア要件 | 調整値 | 有利要素 |
|------|----------|--------|---------|
| 逃げ・先行 | 50以上 | -1.8 | +1 |
| 逃げ・先行 | 40-49 | -0.8 | 0 |
| 逃げ・先行 | 40未満 | 0 | 0（恩恵なし） |
| 前方位置（30%以内） | 45以上 | -1.8 | +1 |
| 前方位置（30%以内） | 35-44 | -0.7 | 0 |
| 差し・追込 | - | +1.8 | -1（不利） |

##### **ミドルペース**

| 条件 | スコア要件 | 調整値 |
|------|----------|--------|
| 差し | 50以上 | -1.2 |
| 差し | 40-49 | -0.5 |

#### 3. コース特性による調整（`lib/race-pace-predictor.ts` 139-198行目）

##### **枠の有利不利**

| 設定 | 条件 | 調整値 | 要素 |
|------|------|--------|------|
| `uchi-mae`（内枠前有利） | 内枠1-2番 | -1.2 | 有利+1 |
| `uchi-mae` | 外枠7-8番 | +1.5 | 不利+1 |
| `soto-ushiro`（外枠後方有利） | 外枠7-8番 | -0.8 | 有利+1 |
| `soto-ushiro` + 後方位置 | 外枠 + 後方50% | -0.6 | 追加 |

##### **坂・直線距離**

| 条件 | 調整値 | 要素 |
|------|--------|------|
| ゴール前に坂 + 逃げ・先行 | -1.5 | 有利+1 |
| ゴール前に坂 + 追込 | +1.0 | 不利+1 |

#### 4. 斤量による調整（`app/components/CourseStyleRacePace.tsx` 310-331行目）

全頭の平均斤量との差で評価：

| 斤量差 | 調整値 |
|--------|--------|
| -2.0kg以上軽い | -2.5 |
| -1.0kg以上軽い | -1.5 |
| -0.5kg以上軽い | -0.8 |
| +0.5kg以上重い | +0.8 |
| +1.0kg以上重い | +1.5 |
| +2.0kg以上重い | +2.5 |

#### 5. 有利要素・不利要素によるボーナス/ペナルティ

##### **有利要素ボーナス**

| 有利要素数 | 調整値 |
|-----------|--------|
| 3個以上 | -3.0（先頭争い） |
| 2個 | -1.5（上位争い） |

##### **不利要素ペナルティ**

| 不利要素数 | 調整値 |
|-----------|--------|
| 4個以上 | +6.0（完全後退） |
| 3個 | +4.5 |
| 2個 | +2.5 |

#### 6. 低スコア馬の有利要素相殺（厳格化）

| スコア範囲 | 有利要素 | 相殺調整 |
|-----------|---------|---------|
| 1-20点 | 2個以上 | +4.0（完全相殺＋後退） |
| 1-20点 | 1個 | +2.0 |
| 21-30点 | 2個以上 | +3.0 |
| 21-30点 | 1個 | +1.5 |

#### 7. 大敗続き馬の特別処理（`lib/race-pace-predictor.ts` 173-236行目）

```typescript
function checkConsistentLoser(db, horseName): boolean {
  // 1走のみで3.0秒以上の大敗
  if (records.length === 1 && timeDiffs[0] >= 3.0) {
    return true;
  }
  
  // 直近2走に0.3秒差以内の好走があれば除外
  if (goodRunCount > 0) {
    return false;
  }
  
  // 3走中2走以上が2.0秒差以上の大敗
  if (bigLossCount >= 2) {
    return true;
  }
  
  // 平均着差が1.5秒以上
  if (avgDiff >= 1.5) {
    return true;
  }
}
```

**大敗続き馬の処理**:
```typescript
if (isConsistentLoser) {
  return totalHorses * 1.8; // 最後尾よりさらに後ろに強制配置
}
```

---

## 視覚化の仕様

### 1. 馬群グルーピング（`app/components/CourseStyleRacePace.tsx` 458-476行目）

```typescript
// 位置差が1.5馬身以下なら同じグループ
const groupThreshold = 1.5;
const groups: number[][] = [];

for (let i = 1; i < sorted.length; i++) {
  if (currPos - prevPos <= groupThreshold) {
    currentGroup.push(i);  // 同じグループ
  } else {
    groups.push(currentGroup);
    currentGroup = [i];    // 新しいグループ
  }
}
```

**結果**: 自然に4-5グループ程度にまとまる

### 2. 横方向の配置（`app/components/CourseStyleRacePace.tsx` 478-523行目）

```typescript
// 段（レーン）配置の設定
const minGap = 6.5;      // 行内での最低ギャップ（%）
const groupGap = 12;     // グループ間の追加ギャップ（%）
const maxX = 94;
const minX = 1;
const lanes = 3;         // 最大段数
const laneHeight = 26;   // 段差
const jitter = 10;       // 縦の微揺らぎ（±10px）
```

#### 配置ルール
1. **基本X座標**: 位置を0-100%に変換
2. **枠番補正**: `(枠番 - 4.5) × 0.8` （外枠は外側へ）
3. **グループ間ギャップ**: グループが変わったら+12%
4. **レーン選択**: 上段優先で詰める、重なったら次の段へ
5. **縦揺らぎ**: ±10pxでランダムに上下

### 3. 馬アイコンのサイズと色

```typescript
// サイズ
- tiny: 8×8（32px）
- small: 10×10（40px）
- normal: 14×14（56px）

// 色: 枠番に応じた配色
1枠: 白（黒枠）
2枠: 黒
3枠: 赤
4枠: 青
5枠: 黄
6枠: 緑
7枠: オレンジ
8枠: ピンク
```

---

## 来る可能性が高い馬の判定

### 判定ロジック（厳格化版）（`app/components/CourseStyleRacePace.tsx` 412-435行目）

```typescript
// スコアが低い馬は絶対に浮上させない
if (kisoScore < 40) {
  return; // マーキング対象外
}

const positionGain = startPos.expectedPosition2C - g.expectedPositionGoal;

// 【強】スコア70以上 かつ 大きく前進（6.0以上）または ゴール1-2位
if (kisoScore >= 70 && (positionGain >= 6.0 || index < 2)) {
  surgeHorses.set(g.horseNumber, 'strong');
}
// 【中】スコア60以上 かつ 中程度前進（4.5以上）または ゴール3位以内
else if (kisoScore >= 60 && (positionGain >= 4.5 || index < 3)) {
  surgeHorses.set(g.horseNumber, 'medium');
}
// 【弱】スコア50以上 かつ やや前進（3.5以上）または ゴール5位以内
else if (kisoScore >= 50 && (positionGain >= 3.5 || index < 5)) {
  surgeHorses.set(g.horseNumber, 'weak');
}
```

### エフェクト表示

| 強度 | 条件 | 噴射量 |
|------|------|--------|
| **強** | スコア70以上 + 大きく前進 | 3本の噴射線 |
| **中** | スコア60以上 + 中程度前進 | 2本の噴射線 |
| **弱** | スコア50以上 + やや前進 | 1本の噴射線 |

---

## バイアス設定

### 設定可能なバイアス（`app/components/CourseStyleRacePace.tsx` 346-404行目）

| バイアス | 説明 | 逃げ・先行 | 差し・追込 | 内枠 | 外枠 |
|---------|------|-----------|-----------|------|------|
| `none` | バイアスなし | 0 | 0 | 0 | 0 |
| `uchi-mae` | 内枠前有利 | -0.8 | +0.5 | -1.0（1-2枠） | +0.8（7-8枠） |
| `soto-ushiro` | 外枠後方有利 | +0.5 | -0.8 | +0.8（1-2枠） | -1.0（7-8枠） |
| `mae` | 前有利 | -1.0 | +0.6 | 0 | 0 |
| `ushiro` | 後方有利 | +0.6 | -1.0 | 0 | 0 |
| `uchi` | 内枠有利 | 0 | 0 | -1.0（1-2枠） | +0.8（7-8枠） |
| `soto` | 外枠有利 | 0 | 0 | +0.8（1-2枠） | -1.0（7-8枠） |

---

## まとめ

### 展開予想の精度を支える要素

1. ✅ **過去走データの統計処理**（平均位置、前半2Fラップ）
2. ✅ **脚質の自動判定**（4段階分類）
3. ✅ **ペースの影響を反映**（スロー/ミドル/ハイ）
4. ✅ **コース特性の考慮**（枠・坂・直線）
5. ✅ **競うスコアとの連携**（実力評価）
6. ✅ **スコア別の最大前進制限**（過大評価防止）← v4.0追加
7. ✅ **位置条件の追加**（ハイペース×差し馬）← v4.0追加
8. ✅ **大敗続き馬の検出**（失速リスク排除）
9. ✅ **有利要素と不利要素の総合評価**（複合効果）
10. ✅ **視覚的な馬群表現**（4-5グループ化）

### 改善のポイント（v4.0）

#### 1. **スコア別の最大前進制限**
- **問題**: 展開が恵まれるだけで低スコア馬が過度に浮上
- **解決**: スコアに応じた物理的な上限を設定
- **効果**: スコア25点の馬が先頭に来るような非現実的な展開を防止

#### 2. **ハイペース×差し馬の位置条件**
- **問題**: 前方にいる差し馬もハイペース恩恵を受けていた
- **解決**: 「後方50%以上の位置」を追加条件に
- **効果**: 現実的な展開予想（前方差し馬は恩恵なし）

#### 3. **大敗続き判定の厳格化**
- **問題**: 平均1.5秒差では甘すぎる
- **解決**: 直近3走の平均を1.2秒に厳格化
- **効果**: より確実に失速リスクのある馬を排除

#### 4. **位置条件の徹底**
- **問題**: 脚質とスコアだけでペース恩恵を判定
- **解決**: 実際のスタート位置も条件に含める
- **効果**: 隊列に忠実な展開予想

### v3.0からの進化

| 項目 | v3.0 | v4.0 |
|------|------|------|
| 低スコア馬の浮上 | 有利要素で相殺 | **最大前進制限で物理的に防止** |
| ペース恩恵 | スコアのみで判定 | **スコア + 位置条件** |
| 大敗続き基準 | 平均1.5秒 | **平均1.2秒（厳格化）** |
| 展開の現実性 | やや甘い | **隊列忠実＋根拠重視** |

### コンセプト

**「隊列と想定ペースに忠実、それでいて競うスコア上位かつ隊列が恵まれた馬だけが浮上する」**

- ❌ 根拠のない馬は浮上しない
- ❌ スコアが低い馬は展開が向いても限定的
- ❌ 前方にいる差し馬はハイペースの恩恵なし
- ✅ スコア60以上＋後方位置＋ハイペース = 大きく浮上
- ✅ 突き抜けるのはプラス要素が重なった場合のみ

---

**📝 ドキュメント終了**


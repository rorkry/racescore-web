# RaceScore Web - TODO

## 完了済み
- [x] CSVアップロード機能
- [x] 競うスコア計算（巻き返し指数ベース）
- [x] 印の自動割当（◎○▲☆△）
- [x] 出馬表の表示改善
- [x] PDF出力機能の基本構造（開催地ごと）
- [x] PDF出力の日本語フォント対応（html2canvas使用）
- [x] PDF出力とWebページの見やすさ改善
- [x] 競う指数タブのデザイン改善（参考画像に基づく）
- [x] 動作確認とGitHubへのプッシュ
- [x] プロキシ設定の削除（next.config.ts）
- [x] 不要なAPIルート（trio）の外部サーバーフォールバック削除
- [x] Metadataの警告修正（generateViewport使用）
- [x] lib/db.tsのreadonly: trueオプションを削除
- [x] データベース初期化処理を追加（CREATE TABLE）
- [x] 不要なオッズデータ関連のコードを削除

## 新規タスク（2024-12-19 馬柱情報充実）
- [x] 馬番セルの枠番背景色実装（既に実装済み）
- [x] 印のUI改善
  - 馬番と馬名の間に移動
  - 横並びボタン → 選択タブ（ドロップダウン）に変更
- [x] 過去5走の表示形式改善
  - 時計表記を1538→1.53.8に変更（既に実装済み）
  - 馬場状態、コース、距離を追加
  - クラス、人気、着順を追加（既に実装済み）
  - 勝ち馬との時間差を追加（既に実装済み）
- [x] 動作確認（npm run dev）
- [x] GitHubへのプッシュ

## 新規タスク（2024-12-19 PDF出力改善）
- [x] レース表記を「阪神1R (クラス) ダ1800m」形式に変更
- [x] 表の囲い線を濃くする
- [x] 馬番の0を削除（01→1、02→2）
- [x] 「予測勝率」→「競うスコア」に訂正
- [x] PDF表をポスター会社レベルに改善
  - ヘッダー：濃い青色＋白文字＋太字
  - 馬番セル：枠番色の背景＋白文字＋太字
  - スコアセル：色グラデーション＋太字
  - 1-3位：背景色を濃く
  - 行間を広げる
  - フォントサイズを大きく
- [x] 動作確認（PDF出力）
- [x] GitHubへのプッシュ

## 新規タスク（2024-12-19 PDF表の枠番表示改善）
- [x] 枠番セルを馬番セルの左側に追加（色のみ、数字なし）
- [x] 馬番セルは白背景＋黒文字に変更
- [x] 芝ダートをレース表記に追加（wakujun.csvのO列から取得）
- [x] 馬名のフォントサイズを大きく
- [x] 動作確認（PDF出力）
- [x] GitHubへのプッシュ

## 新規タスク（2024-12-19 PDF表の騎手名・斤量追加）
- [x] 馬名の前の記号（$、*など）を削除
- [x] 「競うスコア」の列名を小さく（1行に収まるように）
- [x] 馬名と競うスコアの間に「騎手名」と「斤量」の列を追加
- [x] 動作確認（PDF出力）
- [x] GitHubへのプッシュ

## 新規タスク（2024-12-19 PDF軽量化）
- [x] 現在のPDF生成コードを確認（jsPDF設定）
- [x] 画像圧縮設定を追加
- [x] フォント埋め込みを最適化
- [x] PDF圧縮オプションを有効化
- [x] 動作確認（90MB → 数MB以下に削減）
- [x] GitHubへのプッシュ

## 新規タスク（2024-12-19 PDF表デザイン微修正）
- [x] 距離の前に芝/ダート区別を表示（umadata.csvのO列から取得）
- [x] 囲い線を細くしてスタイリッシュに（太すぎて見にくい問題を解消）
- [x] ヘッダーの青を明るく＋文字サイズを大きく（視認性向上）
- [x] 動作確認（PDF出力）
- [x] GitHubへのプッシュ

## 新規タスク（2024-12-19 地方競馬・新馬戦の評価問題）
- [x] 現在の基準值22の問題を確認（地方競馬・新馬戦で不適切に加算される）
- [x] 地方競馬・新馬戦の識別方法を実装（競馬場名、クラス名から判定）
- [x] 地方競馬用の簡易評価ロジックを実装（時計、着差、着順から指数化）
- [x] 新馬戦・評価不可能なレースの扱いを決定（0点 or 低めの基準值）
- [x] 動作確認（地方競馬歴のある馬でテスト）
- [x] GitHubへのプッシュ

## 新規タスク（2024-12-19 前走データなし馬の識別）
- [x] スコア計算関数を修正（データなしフラグを返す）
- [x] 表示ロジックを修正（「データなし」表示）
- [x] ソートロジックを修正（データなし馬を最下位配置）
- [x] PDF出力にも反映（「データなし」表示）
- [x] 動作確認
- [x] GitHubへのプッシュ

## 新規タスク（2024-12-19 外国産馬マーク問題）
- [x] ピコテンダーのデータを確認（前走中央競馬で走っているのにスコアマイナス）
- [x] 馬名正規化処理を確認（$、*マークの扱い）
- [x] 問題の原因を特定（pastMap生成時の馬名マッチング）
- [x] 修正を実装（馬名正規化処理の改善）
- [x] 動作確認（外国産馬でテスト）
- [x] GitHubへのプッシュ

## バージョン1.0リリース（2024-12-19）
- [x] Gitタグv1.0を作成
- [x] タグをGitHubにプッシュ
- [x] バージョン情報をREADMEに追記
- [x] 完了報告

## CSV管理機能のバックエンド移行（2024-12-19）

### Phase 1: 現状分析
- [x] 現在のCSV読み込み処理を特定（app/page.tsx）
- [x] データ構造（CSVの列、オブジェクト形式）を特定
- [x] 既存の計算ロジック（競うスコア、馬柱表示）への依存関係を確認

### Phase 2: データベース設計
- [x] drizzle/schema.tsにumadataテーブルを追加
- [x] CSVの構造に完全一致するカラム定義
- [x] マイグレーション実行（pnpm db:push）

### Phase 3: バックエンド実装
- [ ] CSV保存用のtRPCプロシージャ作成（server/routers.ts）
- [ ] データ取得用のtRPCプロシージャ作成
- [ ] 管理画面用のページ作成（client/src/pages/Admin.tsx）

### Phase 4: フロントエンド改修
- [ ] CSV読み込み処理をAPI呼び出しに置き換え
- [ ] データ形式の整合性確保
- [ ] 既存ロジックとの接続確認

### Phase 5: 回帰テスト
- [ ] 馬柱表示の確認
- [ ] スコア計算の確認
- [ ] PDF出力の確認

### Phase 6: UI整理
- [ ] ナビゲーションバーから「分布」タブを削除
- [ ] 「枠順確定後」タブから「指数」列を削除
- [ ] 「競うスコア」上位を強調表示（赤字/太字）

### Phase 7: 完了
- [ ] GitHubへのプッシュ
- [ ] 完了報告

## データベースベースAPI移行（2024-12-19）

### Phase 1: 競馬スコア計算を含むレースカードAPIの作成
- [x] 競馬スコア計算ロジックをサーバーサイドに移植
- [x] レースカードAPIに競馬スコア計算を統合
- [x] APIのテスト

### Phase 2: レース一覧APIの作成
- [x] 場所別レース一覧APIの作成
- [x] 日付別レース一覧APIの作成

### Phase 3: 既存のapp/page.tsxをAPIベースに移行
- [x] 新しいページ /db-race-card を作成
- [x] APIからデータを取得するように変更
- [x] 競馬スコア表示機能を実装

### Phase 4: PDF生成機能の動作確認と修正
- [x] PDF生成機能の動作確認
- [x] 必要に応じて修正

### Phase 5: 統合テストと最終確認
- [x] 全機能の動作確認
- [x] パフォーマンステスト
- [x] バグ修正

## UI整理とAdmin導線確保（2024-12-19）

### Phase 1: app/page.tsxをDB版レースカードに置き換え
- [x] 現在のapp/page.tsxをバックアップ
- [x] /db-race-cardの内容でapp/page.tsxを置き換え
- [x] CSVアップロード機能を完全に削除
- [x] トップページの動作確認

### Phase 2: 管理者画面へのリンクをヘッダーに追加
- [x] ヘッダーコンポーネントに設定アイコンを追加
- [x] /adminページへのリンクを設定
- [x] デザイン調整

### Phase 3: 不要なページとファイルを削除
- [x] /db-race-cardページを削除
- [x] 古いCSV版の関連ファイルを削除
- [x] 不要なコンポーネントを削除

### Phase 4: 管理者画面の動作確認
- [ ] /adminページでCSVアップロード機能を確認
- [ ] データベースへの保存を確認
- [ ] トップページでの表示を確認

### Phase 5: 最終確認とデプロイ
- [ ] 全機能の動作確認
- [ ] パフォーマンステスト
- [ ] GitHubへのプッシュ

## 競馬スコア計算の修正（2024-12-19）

### 問題
- 新しいAPIのスコア計算が既存の実装と異なる
- 既存のcomputeKisoScore関数を使用していない

### 修正内容
- [ ] APIのスコア計算をcomputeKisoScore関数に置き換え
- [ ] スコアの整合性を確認
- [ ] 既存のCSV版と新しいDB版でスコアが一致することを確認


## UI改善（2024-12-20）

### タイトルと色味調整
- [x] タイトルを「緑の組織」に変更
- [x] 「競馬スコア」を「競うスコア」に変更
- [x] サイト全体の色味調整
  - ページ背景: bg-slate-50 (#F8FAFC)
  - カード背景: bg-white (#FFFFFF)
  - 文字色（基本）: text-slate-800 (#1E293B)
  - 文字色（補足）: text-slate-500 (#64748B)
  - 罫線: border-slate-800 (#1E293B) - 黒で統一
  - ゼブラストライプ: even:bg-slate-50

### 過去走表示項目の調整
- [x] 表示項目: 日付、場所、クラス、距離、人気、着順、着差、通過、巻き返し指数
- [x] PCI列を削除
- [x] タイム列を削除
- [x] 囲い線を黒で統一
- [x] 色付けは文字のみに変更（背景色ではなく）

### PDFダウンロード機能追加
- [x] 各競馬場毎のPDFダウンロードボタンを追加
- [x] 競馬場選択ボタンの横にダウンロードアイコンを配置

### レースカード表示の改善
- [x] 「過去走」列を削除（馬名クリックで表示されるため不要）

### バグ修正
- [x] React keyプロパティの警告を修正

### 馬名マッチングのバグ修正（2024-12-20）
- [x] $マーク（外国産馬）、*マーク（地方競馬）を含む馬名の正規化処理を追加
- [x] normalizeHorseName関数を実装
- [x] 動作確認（$ピコテンダー、$キングズブレスなど）

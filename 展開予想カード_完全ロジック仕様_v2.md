# 展開予想カード 完全ロジック仕様書 v2.0

## 目次
1. [概要](#概要)
2. [スタート位置（2コーナー）計算ロジック](#スタート位置2コーナー計算ロジック)
3. [ゴール位置調整ロジック](#ゴール位置調整ロジック)
4. [レイアウト・表示ロジック](#レイアウト表示ロジック)
5. [噴射エフェクト判定ロジック](#噴射エフェクト判定ロジック)
6. [全係数・閾値一覧](#全係数閾値一覧)

---

## 概要

### システム構成
```
データ取得（umadata, indices）
  ↓
スタート位置計算（lib/race-pace-predictor.ts）
  ↓
ゴール位置調整（CourseStyleRacePace.tsx）
  ↓
レイアウト計算（横方向・縦方向）
  ↓
噴射エフェクト判定
  ↓
画面表示
```

### データソース
- **umadata**: 馬の過去走データ（通過順位、距離、着順など）
- **indices**: 各種指数（前半2F、巻き返し指数、ポテンシャル指数など）
- **wakujun**: 出走馬の基本情報（馬番、枠番、斤量など）
- **競うスコア**: 0-100点の総合評価スコア

---

## スタート位置（2コーナー）計算ロジック

### 1. データ収集フェーズ

#### 1.1 前半2Fラップタイムの計算
**関数**: `calculateAvgFront2FLap(db, horseName)`

```typescript
// データソース: indicesテーブルのT2F列
// 対象: 過去走すべて（LIMIT なし）

// データ取得ロジック
1. umadataから馬のrace_id_new_no_horse_num（16桁）とhorse_numberを取得
2. 18桁のrace_idを構築: race_id_new_no_horse_num + horse_number（2桁パディング）
3. indicesテーブルからT2Fを取得

// 前半2Fがない場合の推定ロジック
if (T2Fがない && corner_2データあり) {
  corner_2の位置から前半2Fを推定:
    - 1位 = 23.0秒
    - 2-3位 = 23.0 + (順位 - 1) × 0.4秒
    - 4-6位 = 23.8 + (順位 - 3) × 0.3秒
    - 7-10位 = 24.7 + (順位 - 6) × 0.3秒
    - 11位以降 = 25.9 + (順位 - 10) × 0.15秒
  estimatedFromPosition = true
}

// 返り値
{
  avgLapTime: 平均ラップタイム（秒）,
  raceCount: データ件数,
  fastestLap: 最速ラップタイム（秒）,
  estimatedFromPosition: 推定データかどうか
}
```

#### 1.2 2コーナー通過順位の計算
**関数**: `calculateAvgPosition2C(db, horseName, currentDistance)`

```typescript
// データソース: umadataのcorner_2列
// 対象: 過去走すべて（LIMIT なし）

// 距離フィルタリング
1. 全過去走からcorner_2とdistanceを取得
2. 距離±200m範囲内のデータを nearDistancePositions に格納
3. 距離±200m範囲外のデータを allPositions に格納
4. 優先順位:
   - nearDistancePositions が3件以上ある → nearDistancePositions を使用
   - それ以外 → allPositions を使用

// 逃げ経験のカウント
corner_2 = 1位の回数をカウント
  - escapeCount: 逃げた回数
  - hasEscapeExperience: 1回でも逃げたことがあるか

// 返り値
{
  avgPosition: 平均2コーナー通過順位,
  raceCount: データ件数,
  hasEscapeExperience: 逃げた経験があるか,
  escapeCount: 逃げた回数
}
```

#### 1.3 前走距離の取得
**関数**: `getLastDistance(db, horseName)`

```typescript
// データソース: umadataのdistance列
// 対象: 前走1走のみ（LIMIT 1）

SELECT distance
FROM umadata
WHERE horse_name = ?
ORDER BY race_id_new_no_horse_num DESC
LIMIT 1

// 返り値: 距離（メートル）または null
```

#### 1.4 大敗続き馬の判定
**関数**: `checkConsistentLoser(db, horseName)`

```typescript
// データソース: umadataのfinish_time, standard_time
// 対象: 直近3走（LIMIT 3）

// 判定条件
1. 1走のみで3.0秒以上の大敗 → true（経験不足＋大敗）
2. 直近2走に0.3秒差以内の好走がある → false（除外）
3. 3走中2走以上が2.0秒差以上の大敗 → true
4. 直近3走の平均着差が1.2秒以上 → true
5. 3走未満の場合、全体の平均着差が1.5秒以上 → true
6. それ以外 → false

// 着差の計算
timeDiff = finishTime - standardTime
```

### 2. 位置計算フェーズ

#### 2.1 全頭データの収集と相対評価

```typescript
// 第1ループ: 全頭のデータを収集
tempHorseData = []
for (各馬) {
  avgPosition, escapeCount = calculateAvgPosition2C()
  avgLapTime, fastestLap = calculateAvgFront2FLap()
  lastDistance = getLastDistance()
  
  tempHorseData.push({馬情報, 各種データ})
}

// 最速ラップの相対評価用閾値を計算
allFastestLaps = tempHorseData.map(d => d.fastestLap).sort(昇順)
fastestLapTop10Threshold = allFastestLaps[10%位]
fastestLapTop25Threshold = allFastestLaps[25%位]
```

#### 2.2 基本位置（basePosition）の決定

```typescript
// データ有無の判定
hasPositionData = posRaceCount > 0  // 通過順位データあり
hasLapData = lapRaceCount > 0        // 前半2Fデータあり

// 完全にデータなし → 最後方固定
if (!hasPositionData && !hasLapData) {
  basePosition = 総頭数 + 2  // 末尾より後ろ
}
// 通過順位データあり
else if (avgPosition !== null) {
  basePosition = avgPosition
}
// 通過順位なし、ラップあり → 中団やや後ろ
else {
  basePosition = 総頭数 × 0.6
}
```

#### 2.3 前半2Fラップタイムによる調整

```typescript
// データが十分ある場合（3レース以上）
if (avgLapTime !== null && lapRaceCount >= 3) {
  if (avgLapTime < 23.0) {
    basePosition -= 3.5  // 非常に速い = 大きく前に
  } else if (avgLapTime < 23.5) {
    basePosition -= 2.5
  } else if (avgLapTime < 24.0) {
    basePosition -= 1.2
  } else if (avgLapTime < 24.5) {
    basePosition -= 0.5
  } else if (avgLapTime > 25.5) {
    basePosition += 2.5  // 遅い = 後ろに
  } else if (avgLapTime > 25.0) {
    basePosition += 1.2
  }
}
// データが少ない場合（1-2レース）→ 控えめに調整
else if (avgLapTime !== null && lapRaceCount > 0 && lapRaceCount < 3) {
  if (avgLapTime < 23.5) {
    basePosition -= 1.5  // 速い
  } else if (avgLapTime < 24.5) {
    basePosition -= 0.5
  } else if (avgLapTime > 25.5) {
    basePosition += 1.5  // 遅い
  } else if (avgLapTime > 25.0) {
    basePosition += 0.8
  }
}
// 前半2Fデータが全くない場合
else {
  if (hasLapData) {
    basePosition += 1.5  // ラップ不明だが少し後ろに
  }
}
```

#### 2.4 最速ラップ（スパイス）による調整

```typescript
// 今回のメンバーと比較して、一度でも突出して速いラップがあれば前へ
if (fastestLap !== null && lapRaceCount >= 2) {
  if (fastestLap <= fastestLapTop10Threshold) {
    // メンバー内で上位10%の最速ラップ
    basePosition -= 1.8
  } else if (fastestLap <= fastestLapTop25Threshold) {
    // メンバー内で上位25%の最速ラップ
    basePosition -= 1.0
  }
}
```

#### 2.5 距離変更による調整

```typescript
if (lastDistance !== null) {
  distanceChange = currentDistance - lastDistance
  
  // 距離延長 = 前に行く傾向
  if (distanceChange >= 400) {
    basePosition -= 2.5  // 大幅延長
  } else if (distanceChange >= 200) {
    basePosition -= 1.5
  }
  
  // 距離短縮 = 控える傾向
  else if (distanceChange <= -400) {
    basePosition += 2.5  // 大幅短縮
  } else if (distanceChange <= -200) {
    basePosition += 1.5
  }
}
```

#### 2.6 逃げ経験による調整

```typescript
if (hasEscapeExperience) {
  if (escapeCount >= 3) {
    // 3回以上逃げた経験 = 大きく前に
    basePosition -= 2.0
  } else if (escapeCount >= 2) {
    // 2回逃げた経験 = 中程度前に
    basePosition -= 1.2
  } else if (escapeCount === 1) {
    // 1回だけ逃げた経験 = やや前に
    basePosition -= 0.6
  }
}
```

#### 2.7 コース・枠順補正

**関数**: `adjustPositionByCourseAndWaku()`

```typescript
// 最初のコーナーまでが短い（< 300m）= 内枠有利
if (distToCorner < 300) {
  if (waku <= 2) {
    adjustment = courseChar.innerFrameAdvantage × 1.5
  } else if (waku <= 4) {
    adjustment = courseChar.innerFrameAdvantage × 0.8
  } else if (waku >= 7) {
    adjustment = courseChar.outerFrameAdvantage × 1.2  // 外枠は不利
  } else if (waku >= 6) {
    adjustment = courseChar.outerFrameAdvantage × 0.7
  }
}
// 最初のコーナーまで余裕あり（>= 500m）= 外枠有利
else if (distToCorner >= 500) {
  if (waku >= 7) {
    adjustment = courseChar.outerFrameAdvantage × 1.5
  } else if (waku >= 5) {
    adjustment = courseChar.outerFrameAdvantage × 0.8
  } else if (waku <= 2) {
    adjustment = courseChar.innerFrameAdvantage × 0.8  // 内枠は不利
  }
}
// 中間（300-500m）= どちらもあまり影響なし
else {
  if (waku <= 2) {
    adjustment = courseChar.innerFrameAdvantage × 0.6
  } else if (waku >= 7) {
    adjustment = courseChar.outerFrameAdvantage × 0.6
  }
}

// 芝スタートダートの場合、外枠有利
if (courseChar.turfStartDirt && waku >= 6) {
  adjustment -= 0.8
}

// タイトなコーナーの場合、内枠有利
if (courseChar.tightCorner && waku <= 3) {
  adjustment -= 0.7
}

// デフォルト補正（コース特性データがない場合）
else {
  if (totalHorses >= 16) {
    if (waku <= 2) adjustment = -0.8
    else if (waku >= 7) adjustment = +1.2
  } else if (totalHorses >= 12) {
    if (waku <= 2) adjustment = -0.5
    else if (waku >= 6) adjustment = +0.8
  }
}
```

#### 2.8 脚質推定

**関数**: `estimateRunningStyleWithDistanceChange()`

```typescript
// 前半2Fによるバイアス
styleBias = 0
if (avgLapTime !== null && lapConfidence >= 3) {
  if (avgLapTime < 23.0) {
    styleBias = -4.0  // 強化
  } else if (avgLapTime < 23.5) {
    styleBias = -3.0  // 強化
  } else if (avgLapTime < 24.0) {
    styleBias = -1.5
  } else if (avgLapTime > 25.5) {
    styleBias = +3.0  // 強化
  } else if (avgLapTime > 25.0) {
    styleBias = +1.5
  }
}

// 距離変更バイアス
distanceChangeBias = 0
if (lastDistance !== null) {
  distanceChange = currentDistance - lastDistance
  
  if (distanceChange >= 400) {
    distanceChangeBias = -3.5
  } else if (distanceChange >= 200) {
    distanceChangeBias = -2.5
  } else if (distanceChange <= -400) {
    distanceChangeBias = +3.5
  } else if (distanceChange <= -200) {
    distanceChangeBias = +2.5
  }
}

// 逃げ経験バイアス
escapeExperienceBias = 0
if (hasEscapeExperience) {
  if (escapeCount >= 3) {
    escapeExperienceBias = -3.0  // 逃げ馬
  } else if (escapeCount >= 2) {
    escapeExperienceBias = -2.0  // 先行馬
  } else {
    escapeExperienceBias = -1.0  // やや前
  }
}

// 最終的な位置取り
adjustedPosition = basePosition 
  + (styleBias × 1.0) 
  + (distanceChangeBias × 1.0)
  + (escapeExperienceBias × 0.8)

// 脚質判定
if (adjustedPosition <= 2) {
  runningStyle = 'escape'  // 逃げ
} else if (adjustedPosition <= 5) {
  runningStyle = 'lead'  // 先行
} else if (adjustedPosition <= 10) {
  runningStyle = 'sashi'  // 差し
} else {
  runningStyle = 'oikomi'  // 追込
}
```

#### 2.9 最終微調整

```typescript
// 枠番による微調整（完全に同じ位置を避ける）
wakuMicroAdjustment = (枠番 - 4.5) × 0.15  // -0.525 〜 +0.525

// 馬番によるさらなる微調整（再現性のある疑似ランダム）
horseMicroAdjustment = ((馬番 × 7 + 13) % 20) / 100  // 0.00 〜 0.19

// 最終スタート位置
expectedPosition2C = adjustedPosition + wakuMicroAdjustment + horseMicroAdjustment
```

### 3. ペース判定

**関数**: `determinePaceWithCourse()`

```typescript
// 基本ペース（コース特性から）
basePace = courseChar.paceTendency  // 'slow', 'middle', 'high'

// 前半2Fラップでペース判定（優先度高）
if (avgFront2FLap !== null) {
  if (avgFront2FLap < 23.0 && frontRunners >= 3) {
    return 'high'
  }
  if (avgFront2FLap < 23.5 && frontRunners >= 4) {
    return 'high'
  }
  if (avgFront2FLap < 24.0 && frontRunners >= 5) {
    return 'high'
  }
  
  if (avgFront2FLap >= 26.0 && frontRunners <= 1) {
    return 'slow'
  }
  if (avgFront2FLap >= 25.5 && frontRunners <= 2) {
    return 'slow'
  }
}

// 逃げ・先行馬の割合
frontRatio = frontRunners / totalHorses
if (frontRatio >= 0.45 || frontRunners >= 6) {
  return 'high'
} else if (frontRatio <= 0.15 || frontRunners <= 1) {
  return 'slow'
}

// 短距離（1400m以下）は基本ハイ傾向
if (distance <= 1400 && frontRunners >= 3) {
  return basePace === 'slow' ? 'middle' : 'high'
}

return basePace
```

---

## ゴール位置調整ロジック

### 1. 大敗続き馬の判定

```typescript
// 大敗続きの馬は無条件で最後尾へ
if (isConsistentLoser) {
  return totalHorses × 1.8  // 最後尾よりさらに後ろに配置
}
```

### 2. 競うスコアによる基本調整

```typescript
adjustment = 0
favorableFactors = 0    // 有利要素カウント
unfavorableFactors = 0  // 不利要素カウント

// スコアが極端に低い馬は他の要素に関係なく大きく後退
if (kisoScore > 0 && kisoScore <= 15) {
  adjustment += 8.0      // 超極端に低いスコア
  unfavorableFactors += 3
} else if (kisoScore > 15 && kisoScore <= 25) {
  adjustment += 6.0      // 極端に低いスコア
  unfavorableFactors += 2
} else if (kisoScore > 25 && kisoScore <= 35) {
  adjustment += 4.5      // 低スコア
  unfavorableFactors++
} else if (kisoScore === 0) {
  adjustment += 5.0      // データなし
  unfavorableFactors += 2
} else if (kisoScore >= 70) {
  adjustment -= 5.0      // 本命は大きく前に
  favorableFactors++
} else if (kisoScore >= 60) {
  adjustment -= 3.5
  favorableFactors++
} else if (kisoScore >= 50) {
  adjustment -= 2.0
} else if (kisoScore >= 40) {
  adjustment -= 1.0
}
```

### 3. 前残り低スコア馬への厳しいペナルティ

```typescript
// スタート後に前にいるのにスコアが低い = 惰性で残っているだけ
isInFrontHalf = startPosition / totalHorses <= 0.4  // 前方40%以内

if (isInFrontHalf) {
  if (kisoScore > 0 && kisoScore <= 30) {
    // 前にいる低スコア馬は大きく後退
    adjustment += 5.0
    unfavorableFactors += 2
  } else if (kisoScore > 30 && kisoScore <= 40) {
    // 前にいる中低スコア馬も後退
    adjustment += 3.0
    unfavorableFactors++
  } else if (kisoScore > 40 && kisoScore <= 50) {
    // 前にいる平凡馬も少し後退
    adjustment += 1.5
  }
}
```

### 4. ペースによる調整（厳格化）

#### 4.1 ハイペース

```typescript
if (pace === 'high') {
  // 後方有利だが、スコアと位置の両方が必要
  if (runningStyle === 'sashi' || runningStyle === 'oikomi') {
    isInRearHalf = startPosition / totalHorses >= 0.5  // 後方50%以上
    
    if (kisoScore >= 60 && isInRearHalf) {
      adjustment -= 3.5  // スコア60以上＋後方位置
      favorableFactors++
    } else if (kisoScore >= 50 && isInRearHalf) {
      adjustment -= 2.0
    } else if (kisoScore >= 45) {
      adjustment -= 0.8  // 位置が悪くても最小限の恩恵
    }
    // スコア45未満または前方位置なら恩恵なし
  }
  
  // スタート後に後方にいた馬も、スコアが必要
  if (startPosition > totalHorses × 0.6) {
    if (kisoScore >= 50) {
      adjustment -= 2.5
      favorableFactors++
    } else if (kisoScore >= 40) {
      adjustment -= 1.2
    }
  } else if (startPosition > totalHorses × 0.4) {
    if (kisoScore >= 45) {
      adjustment -= 1.0
    }
  }
  
  // 先行馬は少しバテる
  if (runningStyle === 'escape' || runningStyle === 'lead') {
    if (startPosition < totalHorses × 0.3) {
      adjustment += 2.5
      unfavorableFactors++
    }
  }
}
```

#### 4.2 スローペース

```typescript
else if (pace === 'slow') {
  // 前残りだが、スコアが低い馬は持ちこたえられない
  if (runningStyle === 'escape' || runningStyle === 'lead') {
    if (kisoScore >= 55) {
      // スコア高い先行馬のみ前残り恩恵（厳格化: 50 → 55）
      adjustment -= 1.8
      favorableFactors++
    } else if (kisoScore >= 45) {
      adjustment -= 0.6  // 恩恵を縮小（0.8 → 0.6）
    } else {
      // スコア45未満はスローでも前残りできない
      adjustment += 1.5  // ペナルティ追加
      unfavorableFactors++
    }
  }
  
  // スタート後に前にいた馬も、スコアが必要
  if (startPosition < totalHorses × 0.3) {
    if (kisoScore >= 50) {
      // スコア高い馬のみ前残り恩恵（厳格化: 45 → 50）
      adjustment -= 1.8
      favorableFactors++
    } else if (kisoScore >= 40) {
      adjustment -= 0.4  // 恩恵を縮小（0.7 → 0.4）
    } else {
      // スコア40未満は前残り不可
      adjustment += 1.8
      unfavorableFactors++
    }
  }
  
  // 後方の馬は届きにくい
  if (runningStyle === 'sashi' || runningStyle === 'oikomi') {
    adjustment += 1.8
    unfavorableFactors++
  }
}
```

#### 4.3 ミドルペース

```typescript
else {
  // バランス型、スコアがより重要
  if (runningStyle === 'sashi') {
    if (kisoScore >= 50) {
      adjustment -= 1.2
    } else if (kisoScore >= 40) {
      adjustment -= 0.5
    }
  }
}
```

### 5. コース特性による調整

#### 5.1 直線長による調整

```typescript
if (courseInfo) {
  // 直線が長い（500m以上）= 差し有利
  if (courseInfo.straightLength >= 500) {
    if (runningStyle === 'sashi' || runningStyle === 'oikomi') {
      adjustment -= 2.5  // 強化（1.5 → 2.5）
      favorableFactors++
    }
    // 前に行き過ぎた馬は届かれやすい
    if (runningStyle === 'escape' && startPosition < totalHorses × 0.2) {
      adjustment += 1.8  // 強化（1.0 → 1.8）
      unfavorableFactors++
    }
  }
  
  // 直線が短い（350m未満）= 先行有利
  if (courseInfo.straightLength < 350) {
    if (runningStyle === 'escape' || runningStyle === 'lead') {
      // 短い直線でも、スコアが必要（厳格化）
      if (kisoScore >= 50) {
        adjustment -= 1.8  // 強化（1.0 → 1.8）
        favorableFactors++
      } else if (kisoScore >= 40) {
        adjustment -= 0.8
      }
      // スコア40未満は短い直線でも恩恵なし
    }
    if (runningStyle === 'oikomi' && startPosition > totalHorses × 0.7) {
      adjustment += 2.5  // 強化（1.5 → 2.5、追込は届きにくい）
      unfavorableFactors++
    }
  }
}
```

#### 5.2 枠順有利不利による調整

```typescript
wakuNum = parseInt(waku, 10)

// 外枠有利なコースで外枠の差し・追込馬
if (courseInfo.outerFrameAdvantage < -0.3 && wakuNum >= 6) {
  if (runningStyle === 'sashi' || runningStyle === 'oikomi') {
    adjustment -= 2.0  // 強化（1.2 → 2.0）
    favorableFactors++  // 枠有利
  }
}

// 内枠有利なコースで内枠の先行馬
if (courseInfo.innerFrameAdvantage < -0.5 && wakuNum <= 3) {
  if (runningStyle === 'escape' || runningStyle === 'lead') {
    adjustment -= 1.5  // 強化（0.8 → 1.5）
    favorableFactors++  // 枠有利
  }
}

// 外枠不利なコースで外枠
if (courseInfo.outerFrameAdvantage > 0.5 && wakuNum >= 7) {
  adjustment += 2.0
  unfavorableFactors++  // 枠不利
}

// 内枠不利なコースで内枠
if (courseInfo.innerFrameAdvantage > 0.5 && wakuNum <= 2) {
  adjustment += 1.5
  unfavorableFactors++  // 枠不利
}
```

#### 5.3 坂の影響

```typescript
// ゴール前に坂があるコースは先行有利
if (courseInfo.hasSlope && courseInfo.slopePosition === 'finish') {
  if (runningStyle === 'escape' || runningStyle === 'lead') {
    adjustment -= 1.5  // 強化（0.8 → 1.5）
    favorableFactors++
  }
  if (runningStyle === 'oikomi') {
    adjustment += 1.0  // 強化（0.5 → 1.0、追込は苦しい）
    unfavorableFactors++
  }
}
```

### 6. 総合判定ボーナス

```typescript
// すべての要素が向いている馬はさらに大きく前へ
if (favorableFactors >= 3) {
  // 3つ以上の有利要素 → 先頭争い
  adjustment -= 3.0
} else if (favorableFactors >= 2) {
  // 2つの有利要素 → 上位争い
  adjustment -= 1.5
}

// 不利要素が多い馬はさらに後退
if (unfavorableFactors >= 4) {
  adjustment += 6.0  // 4つ以上は完全に見込みなし
} else if (unfavorableFactors >= 3) {
  adjustment += 4.5  // 強化（4.0 → 4.5）
} else if (unfavorableFactors >= 2) {
  adjustment += 2.5  // 強化（2.0 → 2.5）
}
```

### 7. 低スコア馬の有利要素無効化

```typescript
// スコアが極端に低い馬は、有利要素があっても後退させる
if (kisoScore > 0 && kisoScore <= 20) {
  // 超低スコア馬：有利要素を完全に無効化＋さらに後退
  if (favorableFactors >= 2) {
    adjustment += 6.0  // 強化（4.0 → 6.0）
  } else if (favorableFactors >= 1) {
    adjustment += 3.5  // 強化（2.0 → 3.5）
  }
} else if (kisoScore > 20 && kisoScore <= 30) {
  // 低スコア馬：有利要素を大幅に減衰
  if (favorableFactors >= 2) {
    adjustment += 4.5  // 強化（3.0 → 4.5）
  } else if (favorableFactors >= 1) {
    adjustment += 2.5  // 強化（1.5 → 2.5）
  }
} else if (kisoScore > 30 && kisoScore <= 40) {
  // 中低スコア馬：有利要素を少し減衰
  if (favorableFactors >= 3) {
    adjustment += 2.5
  } else if (favorableFactors >= 2) {
    adjustment += 1.5
  }
}
```

### 8. 斤量による調整

```typescript
// 全頭の斤量平均を計算
avgKinryo = 全頭の斤量合計 / 頭数

// 各馬の斤量差
kinryoDiff = horse.kinryo - avgKinryo

// 斤量補正
kinryoAdjustment = 0
if (kinryoDiff <= -2.0) {
  // 平均より2kg以上軽い → 大きく有利
  kinryoAdjustment = -2.5
} else if (kinryoDiff <= -1.0) {
  // 平均より1kg以上軽い → 有利
  kinryoAdjustment = -1.5
} else if (kinryoDiff <= -0.5) {
  // 平均よりやや軽い → やや有利
  kinryoAdjustment = -0.8
} else if (kinryoDiff >= 2.0) {
  // 平均より2kg以上重い → 大きく不利
  kinryoAdjustment = +2.5
} else if (kinryoDiff >= 1.0) {
  // 平均より1kg以上重い → 不利
  kinryoAdjustment = +1.5
} else if (kinryoDiff >= 0.5) {
  // 平均よりやや重い → やや不利
  kinryoAdjustment = +0.8
}
```

### 9. 馬場バイアス補正

```typescript
// ユーザーが設定した当日の馬場バイアスを反映
biasAdjust = 0
wakuNum = parseInt(waku, 10)

switch (bias) {
  case 'uchi-mae':  // 内前
    biasAdjust += wakuNum <= 2 ? -1.2 : +0.6
    if (runningStyle === 'escape' || runningStyle === 'lead') 
      biasAdjust -= 0.6
    break
    
  case 'soto-mae':  // 外前
    biasAdjust += wakuNum >= 7 ? -1.2 : +0.6
    if (runningStyle === 'escape' || runningStyle === 'lead') 
      biasAdjust -= 0.6
    break
    
  case 'mae':  // 前
    if (runningStyle === 'escape' || runningStyle === 'lead') 
      biasAdjust -= 1.0
    else 
      biasAdjust += 0.6
    break
    
  case 'ushiro':  // 後ろ
    if (runningStyle === 'sashi' || runningStyle === 'oikomi') 
      biasAdjust -= 1.0
    else 
      biasAdjust += 0.6
    break
    
  case 'uchi':  // 内
    biasAdjust += wakuNum <= 2 ? -1.0 : 0
    biasAdjust += wakuNum >= 7 ? +0.8 : 0
    break
    
  case 'soto':  // 外
    biasAdjust += wakuNum >= 7 ? -1.0 : 0
    biasAdjust += wakuNum <= 2 ? +0.8 : 0
    break
    
  case 'soto-ushiro':  // 外後ろ
    biasAdjust += wakuNum >= 7 ? -0.8 : 0
    if (expectedPosition2C > totalHorses × 0.5) 
      biasAdjust -= 0.6
    break
    
  case 'none':  // なし
  default:
    break
}
```

### 10. 噴射対象馬への追加ボーナス

```typescript
// 高スコア馬（噴射対象馬）は更に前進ボーナス
surgeBonus = 0
if (kisoScore >= 70) {
  // 超有力馬は大きく浮上
  surgeBonus = -3.0
} else if (kisoScore >= 60) {
  // 有力馬は中程度浮上
  surgeBonus = -2.0
} else if (kisoScore >= 50) {
  // 中堅馬はやや浮上
  surgeBonus = -1.0
}
```

### 11. 最大前進制限

```typescript
// 暫定ゴール位置
calculatedGoalPosition = startPosition + goalAdjustment + biasAdjust + surgeBonus

// 前進量
positionGain = startPosition - calculatedGoalPosition

// スコア別の最大前進制限
maxAdvance = 10.0  // デフォルト

if (kisoScore === 0) {
  maxAdvance = 0  // データなしは前進不可
} else if (kisoScore <= 20) {
  maxAdvance = 1.5
} else if (kisoScore <= 30) {
  maxAdvance = 2.5
} else if (kisoScore <= 40) {
  maxAdvance = 3.5
} else if (kisoScore <= 50) {
  maxAdvance = 6.0  // 緩和（4.5 → 6.0、噴射対象馬）
} else if (kisoScore <= 60) {
  maxAdvance = 8.0  // 緩和（6.0 → 8.0、噴射対象馬）
} else if (kisoScore <= 70) {
  maxAdvance = 10.0  // 緩和（8.0 → 10.0、噴射対象馬）
} else {
  maxAdvance = 12.0  // 拡大（10.0 → 12.0、超有力馬）
}

// 最大前進を超える場合は制限
if (positionGain > maxAdvance) {
  calculatedGoalPosition = startPosition - maxAdvance
}
```

### 12. 最終ゴール位置

```typescript
expectedPositionGoal = calculatedGoalPosition
```

---

## レイアウト・表示ロジック

### 1. 馬群グルーピング

```typescript
// 位置でソート
sorted = horses.sort((a, b) => position_a - position_b)
positions = sorted.map(h => h.position)

// グルーピング閾値
groupThreshold = 1.5  // 馬身差の閾値

// グループ分け
groups = []
currentGroup = [0]

for (i = 1 to sorted.length) {
  prevPos = positions[i - 1]
  currPos = positions[i]
  
  if (currPos - prevPos <= groupThreshold) {
    // 同じグループに追加
    currentGroup.push(i)
  } else {
    // 新しいグループ開始
    groups.push(currentGroup)
    currentGroup = [i]
  }
}
groups.push(currentGroup)
```

### 2. 横方向配置（X座標）

```typescript
// 配置設定
minGap = 6.5        // 行内での最低ギャップ（%）
groupGap = 12       // グループ間の追加ギャップ（%）
maxX = 94
minX = 1
lanes = 3           // 最大段数
laneHeight = 26     // 段差（px）
jitter = 10         // 縦の微揺らぎ（±10px）

// 各レーンで最後に配置したXを保持
lastXByLane = [minX - minGap, minX - minGap, minX - minGap]
lastGroupIndex = -1

for (各馬) {
  position = horse.position
  
  // 現在の馬がどのグループに属しているか
  currentGroupIndex = groups.findIndex(含まれる)
  
  // グループが変わったら追加の間隔を空ける
  if (currentGroupIndex !== lastGroupIndex && lastGroupIndex !== -1) {
    for (lane = 0 to lanes) {
      lastXByLane[lane] += groupGap
    }
  }
  lastGroupIndex = currentGroupIndex
  
  // 基本のX（位置→%）
  positionRange = maxPosition - minPosition || 1
  xPercent = ((position - minPosition) / positionRange) × (maxX - minX) + minX
  
  // 枠番で微調整（外枠は外側へ）
  wakuNum = parseInt(waku, 10)
  xPercent += (wakuNum - 4.5) × 0.8  // 拡大（0.5 → 0.8）
  
  // 上段優先で詰める。重なりそうなら次の段へ。
  chosenLane = 0
  for (lane = 0 to lanes) {
    if (xPercent - lastXByLane[lane] >= minGap) {
      chosenLane = lane
      break
    }
    if (lane === lanes - 1) {
      chosenLane = lane
      xPercent = lastXByLane[lane] + minGap
    }
  }
  
  lastXByLane[chosenLane] = xPercent
  
  // 画面端で溢れないようクリップ
  xPercent = Math.max(minX, Math.min(maxX, xPercent))
}
```

### 3. 縦方向配置（Y座標・レーン）

```typescript
// 孤立馬の配置改善
currentGroup = groups[currentGroupIndex]
isIsolated = currentGroup.length === 1  // 孤立馬

// 前後の馬との距離
distanceToNext = Infinity
distanceToPrev = Infinity

if (originalIndex < sorted.length - 1) {
  distanceToNext = positions[originalIndex + 1] - position
}
if (originalIndex > 0) {
  distanceToPrev = position - positions[originalIndex - 1]
}

// 孤立馬（前後に3馬身以上離れている）は段を下げる
laneAdjustment = 0
if (isIsolated && distanceToNext >= 3.0 && distanceToPrev >= 3.0) {
  // 完全に孤立 → 中段に配置（上段の無駄なスペースを削減）
  laneAdjustment = 1
  chosenLane = Math.min(chosenLane + laneAdjustment, lanes - 1)
}

// 縦位置：レーン段差＋揺らぎ
jitterOffset = (Math.random() × jitter × 2 - jitter)
yOffset = chosenLane × laneHeight + jitterOffset
```

---

## 噴射エフェクト判定ロジック

### 1. 噴射馬の判定

```typescript
surgeHorses = new Map<horseNumber, 'strong' | 'medium' | 'weak'>()

for (各馬 in goalPosition) {
  startPos = startPosition.find(同じ馬番号)
  
  if (startPos && horse.expectedPositionGoal) {
    positionGain = startPos.expectedPosition2C - horse.expectedPositionGoal
    kisoScore = kisouScores[horse.horseNumber] || 0
    
    // スコアが低い馬は絶対に浮上させない
    if (kisoScore < 40) {
      continue  // マーキング対象外
    }
    
    // 強度判定：噴射の量に反映
    
    // 【強】スコア70以上 かつ 大きく前進（5.0以上）または ゴール1-2位
    if (kisoScore >= 70 && (positionGain >= 5.0 || goalIndex < 2)) {
      surgeHorses.set(horse.horseNumber, 'strong')
    }
    // 【中】スコア60以上 かつ 中程度前進（3.5以上）または ゴール3位以内
    else if (kisoScore >= 60 && (positionGain >= 3.5 || goalIndex < 3)) {
      surgeHorses.set(horse.horseNumber, 'medium')
    }
    // 【弱】スコア50以上 かつ やや前進（2.5以上）または ゴール5位以内
    else if (kisoScore >= 50 && (positionGain >= 2.5 || goalIndex < 5)) {
      surgeHorses.set(horse.horseNumber, 'weak')
    }
  }
}
```

### 2. 噴射エフェクトの視覚化

#### 2.1 【強】噴射

```css
/* 5本のライン、幅・長さ拡大、グロー効果 */
.surge-strong {
  animation: pulse-strong 1.5s ease-in-out infinite;
}

/* ライン1（最太・最長） */
height: 4px (1rem = 0.25rem)
width: 36px (9rem = 2.25rem)
gradient: from-transparent via-orange-500 to-red-600
opacity: 0.95
shadow: shadow-lg shadow-red-500/50

/* ライン2 */
height: 2px
width: 32px
gradient: from-transparent via-orange-400 to-orange-500
opacity: 0.85
shadow: shadow-md shadow-orange-400/50

/* ライン3 */
height: 2px
width: 28px
gradient: from-transparent via-yellow-400 to-orange-400
opacity: 0.80
shadow: shadow-sm shadow-yellow-400/50

/* ライン4 */
height: 1px
width: 24px
gradient: from-transparent via-yellow-300 to-yellow-400
opacity: 0.70

/* ライン5 */
height: 1px
width: 20px
gradient: from-transparent via-yellow-200 to-yellow-300
opacity: 0.60

@keyframes pulse-strong {
  0%, 100% { opacity: 0.95; transform: translateX(0); }
  50% { opacity: 1; transform: translateX(-2px); }
}
```

#### 2.2 【中】噴射

```css
/* 4本のライン、幅・長さ拡大、グロー効果 */
.surge-medium {
  animation: pulse-medium 2s ease-in-out infinite;
}

/* ライン1 */
height: 2px
width: 32px
gradient: from-transparent via-orange-400 to-orange-500
opacity: 0.85
shadow: shadow-md shadow-orange-400/50

/* ライン2 */
height: 2px
width: 28px
gradient: from-transparent via-yellow-400 to-orange-400
opacity: 0.75
shadow: shadow-sm shadow-yellow-400/50

/* ライン3 */
height: 1px
width: 24px
gradient: from-transparent via-yellow-300 to-yellow-400
opacity: 0.65

/* ライン4 */
height: 1px
width: 20px
gradient: from-transparent via-yellow-200 to-yellow-300
opacity: 0.55

@keyframes pulse-medium {
  0%, 100% { opacity: 0.85; transform: translateX(0); }
  50% { opacity: 1; transform: translateX(-2px); }
}
```

#### 2.3 【弱】噴射

```css
/* 3本のライン、幅・長さ拡大、グロー効果 */
.surge-weak {
  animation: pulse-weak 2.5s ease-in-out infinite;
}

/* ライン1 */
height: 2px
width: 28px
gradient: from-transparent via-yellow-400 to-orange-400
opacity: 0.70
shadow: shadow-sm shadow-yellow-400/50

/* ライン2 */
height: 1px
width: 24px
gradient: from-transparent via-yellow-300 to-yellow-400
opacity: 0.60

/* ライン3 */
height: 1px
width: 20px
gradient: from-transparent via-yellow-200 to-yellow-300
opacity: 0.50

@keyframes pulse-weak {
  0%, 100% { opacity: 0.70; transform: translateX(0); }
  50% { opacity: 0.85; transform: translateX(-2px); }
}
```

### 3. 馬アイコンのグロー効果

```typescript
// スコアに応じたグロー効果
kisoScore = kisouScores[horse.horseNumber] || 0
glowIntensity = Math.min(100, Math.max(0, kisoScore - 30)) / 70
// 30点以下は光らない、70点以上で最大

glowColor = `rgba(255, 255, 0, ${glowIntensity × 0.6})`  // 黄色系の光
glowShadow = kisoScore > 30 
  ? `0 0 ${5 + glowIntensity × 10}px ${glowColor}, 0 0 ${2 + glowIntensity × 5}px ${glowColor}` 
  : 'none'
```

---

## 全係数・閾値一覧

### スタート位置計算

| 項目 | 値 | 説明 |
|------|-----|------|
| **前半2F推定閾値** | | |
| 1位 | 23.0秒 | |
| 2-3位 | 23.0 + (順位-1)×0.4秒 | |
| 4-6位 | 23.8 + (順位-3)×0.3秒 | |
| 7-10位 | 24.7 + (順位-6)×0.3秒 | |
| 11位以降 | 25.9 + (順位-10)×0.15秒 | |
| **距離フィルタリング** | | |
| 距離範囲 | ±200m | 優先使用する範囲 |
| 最低データ数 | 3件 | 範囲内データがこれ以上で優先 |
| **大敗続き判定** | | |
| 1走大敗 | ≥3.0秒 | 1走のみでの判定閾値 |
| 好走判定 | ≤0.3秒 | 直近2走での好走閾値 |
| 大敗判定 | ≥2.0秒 | 大敗カウント閾値 |
| 大敗回数 | ≥2回/3走 | 大敗続き判定 |
| 平均着差3走 | ≥1.2秒 | 3走ある場合の閾値 |
| 平均着差3走未満 | ≥1.5秒 | 3走未満の場合の閾値 |

### 前半2F調整（3レース以上）

| 前半2Fタイム | 調整値 | 備考 |
|-------------|--------|------|
| < 23.0秒 | -3.5 | 非常に速い |
| 23.0-23.5秒 | -2.5 | 速い |
| 23.5-24.0秒 | -1.2 | やや速い |
| 24.0-24.5秒 | -0.5 | 平均やや速い |
| 25.0-25.5秒 | +1.2 | やや遅い |
| > 25.5秒 | +2.5 | 遅い |

### 前半2F調整（1-2レース）

| 前半2Fタイム | 調整値 | 備考 |
|-------------|--------|------|
| < 23.5秒 | -1.5 | 速い |
| 23.5-24.5秒 | -0.5 | 平均 |
| 25.0-25.5秒 | +0.8 | やや遅い |
| > 25.5秒 | +1.5 | 遅い |

### 最速ラップ調整

| 順位 | 調整値 | 備考 |
|------|--------|------|
| 上位10% | -1.8 | メンバー内で突出 |
| 上位25% | -1.0 | メンバー内で速い |

### 距離変更調整

| 距離変更 | 調整値 | 備考 |
|---------|--------|------|
| +400m以上 | -2.5 | 大幅延長 |
| +200m以上 | -1.5 | 延長 |
| -200m以下 | +1.5 | 短縮 |
| -400m以下 | +2.5 | 大幅短縮 |

### 逃げ経験調整

| 逃げ回数 | 調整値 | 備考 |
|---------|--------|------|
| 3回以上 | -2.0 | 逃げ馬 |
| 2回 | -1.2 | 先行馬 |
| 1回 | -0.6 | やや前 |

### コース・枠順補正（第1コーナーまでの距離）

#### 短距離（< 300m）= 内枠有利

| 枠番 | 係数 | 備考 |
|------|------|------|
| 1-2枠 | innerFrameAdvantage × 1.5 | 内枠有利 |
| 3-4枠 | innerFrameAdvantage × 0.8 | やや有利 |
| 6枠 | outerFrameAdvantage × 0.7 | やや不利 |
| 7-8枠 | outerFrameAdvantage × 1.2 | 外枠不利 |

#### 長距離（≥ 500m）= 外枠有利

| 枠番 | 係数 | 備考 |
|------|------|------|
| 7-8枠 | outerFrameAdvantage × 1.5 | 外枠有利 |
| 5-6枠 | outerFrameAdvantage × 0.8 | やや有利 |
| 1-2枠 | innerFrameAdvantage × 0.8 | 内枠不利 |

#### 中距離（300-500m）

| 枠番 | 係数 | 備考 |
|------|------|------|
| 1-2枠 | innerFrameAdvantage × 0.6 | 影響小 |
| 7-8枠 | outerFrameAdvantage × 0.6 | 影響小 |

### その他コース補正

| 条件 | 調整値 | 適用枠 |
|------|--------|--------|
| 芝スタートダート | -0.8 | 6枠以上 |
| タイトなコーナー | -0.7 | 3枠以下 |

### デフォルト枠順補正（コース特性データなし）

| 頭数 | 枠番 | 調整値 |
|------|------|--------|
| 16頭以上 | 1-2枠 | -0.8 |
| 16頭以上 | 7-8枠 | +1.2 |
| 12-15頭 | 1-2枠 | -0.5 |
| 12-15頭 | 6-8枠 | +0.8 |

### 脚質推定バイアス

#### styleBias（前半2Fによる、3レース以上）

| 前半2Fタイム | バイアス |
|-------------|---------|
| < 23.0秒 | -4.0 |
| 23.0-23.5秒 | -3.0 |
| 23.5-24.0秒 | -1.5 |
| 25.0-25.5秒 | +1.5 |
| > 25.5秒 | +3.0 |

#### distanceChangeBias

| 距離変更 | バイアス |
|---------|---------|
| +400m以上 | -3.5 |
| +200m以上 | -2.5 |
| -200m以下 | +2.5 |
| -400m以下 | +3.5 |

#### escapeExperienceBias

| 逃げ回数 | バイアス |
|---------|---------|
| 3回以上 | -3.0 |
| 2回 | -2.0 |
| 1回 | -1.0 |

#### 最終調整ウェイト

```
adjustedPosition = basePosition 
  + (styleBias × 1.0) 
  + (distanceChangeBias × 1.0)
  + (escapeExperienceBias × 0.8)
```

### 脚質判定閾値

| adjustedPosition | 脚質 |
|-----------------|------|
| ≤ 2 | 逃げ (escape) |
| 3-5 | 先行 (lead) |
| 6-10 | 差し (sashi) |
| > 10 | 追込 (oikomi) |

### ペース判定

#### 前半2Fによる判定（優先度高）

| 条件 | ペース |
|------|--------|
| avgFront2FLap < 23.0 && frontRunners ≥ 3 | ハイ |
| avgFront2FLap < 23.5 && frontRunners ≥ 4 | ハイ |
| avgFront2FLap < 24.0 && frontRunners ≥ 5 | ハイ |
| avgFront2FLap ≥ 26.0 && frontRunners ≤ 1 | スロー |
| avgFront2FLap ≥ 25.5 && frontRunners ≤ 2 | スロー |

#### 逃げ・先行馬の割合による判定

| 条件 | ペース |
|------|--------|
| frontRatio ≥ 0.45 または frontRunners ≥ 6 | ハイ |
| frontRatio ≤ 0.15 または frontRunners ≤ 1 | スロー |

#### 短距離判定

| 条件 | ペース |
|------|--------|
| distance ≤ 1400m && frontRunners ≥ 3 && basePace ≠ スロー | ハイ |
| distance ≤ 1400m && frontRunners ≥ 3 && basePace = スロー | ミドル |

---

## ゴール位置調整

### 競うスコアによる基本調整

| スコア範囲 | 調整値 | 不利要素 | 備考 |
|-----------|--------|----------|------|
| 0点（データなし） | +5.0 | +2 | データなし |
| 1-15点 | +8.0 | +3 | 超極端に低い |
| 16-25点 | +6.0 | +2 | 極端に低い |
| 26-35点 | +4.5 | +1 | 低スコア |
| 36-39点 | 0 | 0 | 平凡 |
| 40-49点 | -1.0 | 0 | やや良い |
| 50-59点 | -2.0 | 0 | 良い |
| 60-69点 | -3.5 | 有利+1 | 本命候補 |
| 70点以上 | -5.0 | 有利+1 | 本命 |

### 前残り低スコア馬ペナルティ（前方40%以内）

| スコア範囲 | 調整値 | 不利要素 | 備考 |
|-----------|--------|----------|------|
| 1-30点 | +5.0 | +2 | 前にいる低スコア馬 |
| 31-40点 | +3.0 | +1 | 前にいる中低スコア馬 |
| 41-50点 | +1.5 | 0 | 前にいる平凡馬 |

### ペース調整

#### ハイペース - 差し・追込馬

| 条件 | 調整値 | 有利要素 |
|------|--------|----------|
| スコア≥60 && 後方50%以上 | -3.5 | +1 |
| スコア≥50 && 後方50%以上 | -2.0 | 0 |
| スコア≥45 | -0.8 | 0 |
| スコア<45 または 前方位置 | 0 | 0 |

#### ハイペース - スタート後位置による

| 条件 | 調整値 | 有利要素 |
|------|--------|----------|
| 後方60%以上 && スコア≥50 | -2.5 | +1 |
| 後方60%以上 && スコア≥40 | -1.2 | 0 |
| 中団40-60% && スコア≥45 | -1.0 | 0 |

#### ハイペース - 先行馬ペナルティ

| 条件 | 調整値 | 不利要素 |
|------|--------|----------|
| (逃げor先行) && 前方30%以内 | +2.5 | +1 |

#### スローペース - 先行馬

| 条件 | 調整値 | 有利/不利 |
|------|--------|-----------|
| スコア≥55 | -1.8 | 有利+1 |
| スコア≥45 | -0.6 | 0 |
| スコア<45 | +1.5 | 不利+1 |

#### スローペース - スタート後前方30%以内

| 条件 | 調整値 | 有利/不利 |
|------|--------|-----------|
| スコア≥50 | -1.8 | 有利+1 |
| スコア≥40 | -0.4 | 0 |
| スコア<40 | +1.8 | 不利+1 |

#### スローペース - 差し・追込ペナルティ

| 条件 | 調整値 | 不利要素 |
|------|--------|----------|
| 差しor追込 | +1.8 | +1 |

#### ミドルペース - 差し馬

| 条件 | 調整値 |
|------|--------|
| スコア≥50 | -1.2 |
| スコア≥40 | -0.5 |

### コース特性調整

#### 直線長（≥500m）= 差し有利

| 条件 | 調整値 | 有利/不利 |
|------|--------|-----------|
| 差しor追込 | -2.5 | 有利+1 |
| 逃げ && 前方20%以内 | +1.8 | 不利+1 |

#### 直線短（<350m）= 先行有利

| 条件 | 調整値 | 有利/不利 |
|------|--------|-----------|
| (逃げor先行) && スコア≥50 | -1.8 | 有利+1 |
| (逃げor先行) && スコア≥40 | -0.8 | 0 |
| (逃げor先行) && スコア<40 | 0 | 0 |
| 追込 && 後方70%以降 | +2.5 | 不利+1 |

#### 枠順有利不利

| 条件 | 調整値 | 有利/不利 |
|------|--------|-----------|
| 外枠有利(<-0.3) && 6枠以上 && (差しor追込) | -2.0 | 有利+1 |
| 内枠有利(<-0.5) && 3枠以下 && (逃げor先行) | -1.5 | 有利+1 |
| 外枠不利(>0.5) && 7枠以上 | +2.0 | 不利+1 |
| 内枠不利(>0.5) && 2枠以下 | +1.5 | 不利+1 |

#### 坂の影響

| 条件 | 調整値 | 有利/不利 |
|------|--------|-----------|
| ゴール前坂 && (逃げor先行) | -1.5 | 有利+1 |
| ゴール前坂 && 追込 | +1.0 | 不利+1 |

### 総合判定ボーナス

| 有利要素数 | 調整値 |
|-----------|--------|
| ≥3 | -3.0 |
| ≥2 | -1.5 |

| 不利要素数 | 調整値 |
|-----------|--------|
| ≥4 | +6.0 |
| ≥3 | +4.5 |
| ≥2 | +2.5 |

### 低スコア馬の有利要素無効化

#### スコア1-20点

| 有利要素数 | 追加ペナルティ |
|-----------|---------------|
| ≥2 | +6.0 |
| ≥1 | +3.5 |

#### スコア21-30点

| 有利要素数 | 追加ペナルティ |
|-----------|---------------|
| ≥2 | +4.5 |
| ≥1 | +2.5 |

#### スコア31-40点

| 有利要素数 | 追加ペナルティ |
|-----------|---------------|
| ≥3 | +2.5 |
| ≥2 | +1.5 |

### 斤量調整

| 斤量差（kg） | 調整値 |
|------------|--------|
| ≤ -2.0 | -2.5 |
| -2.0 〜 -1.0 | -1.5 |
| -1.0 〜 -0.5 | -0.8 |
| -0.5 〜 +0.5 | 0 |
| +0.5 〜 +1.0 | +0.8 |
| +1.0 〜 +2.0 | +1.5 |
| ≥ +2.0 | +2.5 |

### 馬場バイアス調整

| バイアス | 条件 | 調整値 |
|---------|------|--------|
| 内前 | 1-2枠 | -1.2 |
| 内前 | その他 | +0.6 |
| 内前 | 逃げor先行 | -0.6 |
| 外前 | 7-8枠 | -1.2 |
| 外前 | その他 | +0.6 |
| 外前 | 逃げor先行 | -0.6 |
| 前 | 逃げor先行 | -1.0 |
| 前 | その他 | +0.6 |
| 後ろ | 差しor追込 | -1.0 |
| 後ろ | その他 | +0.6 |
| 内 | 1-2枠 | -1.0 |
| 内 | 7-8枠 | +0.8 |
| 外 | 7-8枠 | -1.0 |
| 外 | 1-2枠 | +0.8 |
| 外後ろ | 7-8枠 | -0.8 |
| 外後ろ | 後方50%以降 | -0.6 |

### 噴射対象馬への追加ボーナス

| スコア範囲 | 調整値 | 備考 |
|-----------|--------|------|
| 70点以上 | -3.0 | 超有力馬 |
| 60-69点 | -2.0 | 有力馬 |
| 50-59点 | -1.0 | 中堅馬 |

### 最大前進制限

| スコア範囲 | 最大前進（馬身） |
|-----------|----------------|
| 0点 | 0 |
| 1-20点 | 1.5 |
| 21-30点 | 2.5 |
| 31-40点 | 3.5 |
| 41-50点 | 6.0 |
| 51-60点 | 8.0 |
| 61-70点 | 10.0 |
| 71点以上 | 12.0 |

---

## レイアウト設定

### グルーピング

| 設定 | 値 |
|------|-----|
| groupThreshold | 1.5馬身 |
| minGap | 6.5% |
| groupGap | 12% |
| maxX | 94% |
| minX | 1% |
| lanes | 3段 |
| laneHeight | 26px |
| jitter | ±10px |
| 枠番調整係数 | 0.8 |

### 孤立馬配置

| 条件 | 処理 |
|------|------|
| グループ人数 = 1 && 前後3馬身以上離れ | 段を1つ下げる（中段へ） |

---

## 噴射エフェクト判定

### 噴射レベル閾値

| レベル | 条件 |
|--------|------|
| 強 | スコア≥70 && (前進≥5.0馬身 or ゴール1-2位) |
| 中 | スコア≥60 && (前進≥3.5馬身 or ゴール3位以内) |
| 弱 | スコア≥50 && (前進≥2.5馬身 or ゴール5位以内) |
| なし | スコア<40 |

### 噴射ライン数と長さ

| レベル | ライン数 | 最大幅 | 最大長さ | グロー |
|--------|----------|--------|----------|--------|
| 強 | 5本 | 4px | 36px | 強 |
| 中 | 4本 | 2px | 32px | 中 |
| 弱 | 3本 | 2px | 28px | 弱 |

### アニメーション

| レベル | 周期 | 動き |
|--------|------|------|
| 強 | 1.5秒 | パルス＋左移動2px |
| 中 | 2.0秒 | パルス＋左移動2px |
| 弱 | 2.5秒 | パルス＋左移動2px |

### グロー効果

```
glowIntensity = Math.min(100, Math.max(0, kisoScore - 30)) / 70
// 30点以下 = 0、70点以上 = 1.0

glowColor = rgba(255, 255, 0, glowIntensity × 0.6)
glowShadow = 0 0 (5 + glowIntensity × 10)px glowColor, 
             0 0 (2 + glowIntensity × 5)px glowColor
```

---

## まとめ

### データフロー

```
1. データ収集
   - 前半2Fラップ（全走 + 推定機能）
   - 2コーナー通過順位（全走、距離フィルタ）
   - 前走距離
   - 大敗続き判定

2. スタート位置計算
   - 基本位置決定
   - 前半2F調整
   - 最速ラップ調整
   - 距離変更調整
   - 逃げ経験調整
   - コース・枠順補正
   - 脚質推定
   - 微調整

3. ペース判定
   - 前半2Fラップ
   - 逃げ・先行馬の割合
   - コース特性

4. ゴール位置調整
   - 大敗続き判定
   - 競うスコア基本調整
   - 前残りペナルティ
   - ペース調整
   - コース特性調整
   - 総合判定ボーナス
   - 低スコア馬の有利要素無効化
   - 斤量調整
   - 馬場バイアス調整
   - 噴射ボーナス
   - 最大前進制限

5. レイアウト計算
   - グルーピング
   - X座標計算（横方向）
   - Y座標計算（縦方向、孤立馬配置改善）

6. 噴射エフェクト判定
   - スコア・前進量・ゴール順位
   - 強度判定（強・中・弱）

7. 画面表示
   - 馬アイコン
   - 噴射エフェクト
   - グロー効果
```

### 設計思想

1. **スタート位置**: 過去実績を最大限活用、データがない場合は推定
2. **ゴール位置**: 総合力（スコア）を最重視、展開・コース・枠を考慮
3. **ペナルティの厳格化**: 低スコア馬が不当に浮上しないよう強力な制限
4. **ボーナスの緩和**: 高スコア馬は大きく浮上できるよう制限を緩和
5. **レイアウト**: 自然なグルーピング、孤立馬の無駄スペース削減
6. **噴射エフェクト**: 能力上位馬の浮上を視覚的に強調

---

**作成日**: 2026年1月5日  
**バージョン**: v2.0  
**対象ファイル**:
- `lib/race-pace-predictor.ts`
- `app/components/CourseStyleRacePace.tsx`











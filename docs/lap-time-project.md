# レースラップ判定プロジェクト仕様書

## 1. 概要

今後の機能拡張として、レースのラップタイムを解析してレースレベルや内容判定を行うシステムを構築する。

## 2. CSV形式の変更点

### 2.1 列数の変化

| 項目 | 現在のCSV | 新CSV |
|------|-----------|-------|
| 列数 | 53列 | **43列** |
| 列0-40 | 一致 | 一致 |

### 2.2 変更された列

| インデックス | 現在の列名 | 新しい列名 | 内容 |
|-------------|-----------|-----------|------|
| 5 | 指数 | **4角位置** | 4コーナーを回った位置（0=最内, 4=大外） |
| 41 | ワーク1S | **ワーク1** | ラップタイムデータ（例: `12.3-10.5-11.8-12.1-12.4-12.6`） |
| 42 | ワーク2S | **ワーク2** | 空（予備列） |

### 2.2.1 4角位置データの仕様

| 値 | 意味 |
|----|------|
| 0 | 最内（インコース） |
| 1 | 内 |
| 2 | 中 |
| 3 | 外 |
| 4 | 大外（アウトコース） |

**活用例:**
- 内有利・前残りのレースで外を回して差し損ねた馬 → 不利な競馬だった可能性
- 外を回しても勝った馬 → 能力の高さを示唆

### 2.3 削除された列（10列）

以下の列は使用されていないため削除：
- ワーク1S → ワーク1に名称変更のみ（インデックス41で維持）
- ワーク2S → ワーク2に名称変更のみ（インデックス42で維持）  
- ワーク1（旧インデックス43）→ 削除
- ワーク2（旧インデックス44）→ 削除
- 馬印2〜馬印8 (horse_mark_2 〜 horse_mark_8)（旧インデックス45-52）→ 削除

### 2.3 変更なしの列

その他の列（レースID、日付、距離、馬番、馬名、着順、タイム等）は変更なし。

## 3. ラップタイムのデータ形式

### 3.1 格納形式

```
12.5-11.8-12.1-11.5-12.0-12.3
```

- 各ハロン（1F = 約200m）のラップを`-`区切りで格納
- 左から順に1F目、2F目、3F目...となる
- **全馬共通のラップ**（レースラップ）であり、各馬個別のラップではない

### 3.2 パース方法

```javascript
function parseLapTimes(lapString) {
  if (!lapString || typeof lapString !== 'string') return [];
  return lapString.split('-').map(lap => parseFloat(lap.trim())).filter(n => !isNaN(n));
}

// 例: "12.5-11.8-12.1-11.5-12.0-12.3"
// 結果: [12.5, 11.8, 12.1, 11.5, 12.0, 12.3]
```

### 3.3 計算例

距離1200m（6F）のレースで `12.3-10.5-11.8-12.1-12.4-12.6` の場合：

| 区間 | 計算 | 値 |
|------|------|-----|
| 前半2F | 12.3 + 10.5 | **22.8秒** |
| 後半3F (上がり3F) | 12.1 + 12.4 + 12.6 | **37.1秒** |
| 後半4F | 11.8 + 12.1 + 12.4 + 12.6 | **48.9秒** |
| 全体 | 合計 | **71.7秒** |

## 4. 今後の開発計画

### Phase 1: データ基盤整備（現在）

- [x] 新CSV形式の仕様確認
- [ ] データベーススキーマの更新（work_1s列をlap_timesにリネームまたは新列追加）
- [ ] インポート処理の更新
- [ ] ラップタイムパース関数の実装

### Phase 2: ラップ分析機能

- [ ] 前半2F、後半3F/4Fの自動計算
- [ ] ペース判定（ハイペース/スロー/ミドル）
- [ ] 高評価ラップパターンのデータベース構築

### Phase 3: レース評価システム

- [ ] ラップパターンからのレースレベル判定
- [ ] 展開予想へのラップ情報統合
- [ ] 俺AI分析への組み込み

## 5. ラップ分析ロジック（実装済み）

### 5.1 ペース判定基準

#### 芝1200m
| 区間 | スロー | 平均 | ハイ | 超ハイ |
|------|--------|------|------|--------|
| 前半2F | ≥22.8秒 | 22.3-22.7秒 | ≤22.2秒 | ≤21.9秒 |
| 前半3F | ≥34.5秒 | 33.8-34.4秒 | ≤33.7秒 | ≤33.0秒 |

#### 芝1400m
| 区間 | スロー | 平均 | ハイ | 超ハイ |
|------|--------|------|------|--------|
| 前半2F | ≥23.0秒 | 22.5-22.9秒 | ≤22.4秒 | ≤21.9秒 |
| 前半3F | ≥34.8秒 | 34.0-34.7秒 | ≤33.9秒 | ≤33.3秒 |

#### 芝1600m
| 区間 | スロー | 平均 | ハイ | 超ハイ |
|------|--------|------|------|--------|
| 前半3F | ≥35.0秒 | 34.3-34.9秒 | ≤34.2秒 | ≤33.9秒 |

#### ダート（距離・芝スタート有無で変動）
詳細は `lib/saga-ai/lap-analyzer.ts` を参照

### 5.2 不利パターン

#### 前傾消耗戦
- 条件：前半3F速い＋上がり遅い
- 不利脚質：逃げ・先行
- 巻き返し対象：着差1秒以内で先行して沈んだ馬

#### スロー瞬発戦
- 条件：前半スロー＋上がり33秒台
- 不利脚質：後方待機の差し・追込
- 巻き返し対象：上がり上位で届かなかった馬

#### ロングスパート戦
- 条件：残り5Fから11秒台続く
- 不利脚質：逃げ・先行
- 巻き返し対象：先行してバテた馬

### 5.3 ハイレベル判定

#### ラップ分類（厳密定義）

| 分類 | 定義 | 例 |
|------|------|-----|
| 加速ラップ | 各ラップが前より速い | 11.5 → 11.4 → 11.3 |
| 非減速ラップ | 全く減速しない（0.0秒差） | 11.5 → 11.5 → 11.5 |
| 微減速ラップ | 0.1〜0.2秒の減速 | 11.5 → 11.6 → 11.7 |
| 減速ラップ | 0.3秒以上の減速 | 11.5 → 11.8 → 12.0 |

#### ペース連動評価

| ペース | ラップ | 評価 | スコア |
|--------|--------|------|--------|
| ミドル以上 | 加速 | 非常に強い内容 | +10 |
| ミドル以上 | 非減速 | 強い内容 | +7 |
| ミドル以上 | 微減速(≤0.2) | 評価できる | +4 |
| スロー | 加速 | 評価できる | +6 |
| スロー | 非減速 | 評価できる | +4 |
| スロー | 微減速 | 低レベルの可能性 | -2 |
| スロー | 減速 | 低レベル | -3 |

#### ハイレベルタイプ

1. **加速ラップ馬**：後半3Fが各ラップ加速して勝利
2. **非減速ラップ馬**：後半で全く減速せず勝利（微減速でもペース次第で評価）
3. **逆行ハイレベル**：不利パターンで1-2着かつ外を回った馬

### 5.4 表示形式

```
【能力】平均着順2.7着と好調...
【タイム】⏱️優秀: 前走の時計は上位クラスでも通用...
【ラップ】🔥ハイレベル: 前走加速ラップで勝利。(11.8-11.5-11.3) / 💡巻き返し候補: 2走前ハイペースで外3番手先行。着差0.8秒なら巻き返し候補。
```

### 5.5 関連ファイル

| ファイル | 役割 |
|----------|------|
| `lib/saga-ai/lap-analyzer.ts` | ラップ分析ロジック |
| `lib/saga-ai/saga-brain.ts` | 俺AI統合 |
| `app/components/SagaAICard.tsx` | 表示コンポーネント |

## 6. データベース更新案

### 6.1 スキーマ変更

既存の`work_1s`列をそのまま使用可能（ラップタイムが入る）。

```sql
-- 現状のwork_1s列をそのまま使用
-- ラップタイムデータ: "12.3-10.5-11.8-12.1-12.4-12.6"

-- 不要になる列（使用していないので影響なし）
-- horse_mark_2, horse_mark_3, horse_mark_4, horse_mark_5
-- horse_mark_6, horse_mark_7, horse_mark_7_2, horse_mark_8
```

### 6.2 インポート処理の更新

`app/api/upload-csv/route.ts` の `importUmadata` 関数を更新：

**変更前:**
```javascript
if (Array.isArray(row) && row.length >= 50) {
  // row[41] = work_1s
  // row[42-49] = horse_mark_2 through horse_mark_8
}
```

**変更後:**
```javascript
if (Array.isArray(row) && row.length >= 43) {
  // row[41] = work_1s (ラップタイム: "12.3-10.5-11.8...")
  // row[42] = work_2 (予備)
  // row[43-49] は存在しない（削除された）
}
```

### 6.3 必要な修正箇所

1. **`app/api/upload-csv/route.ts`**: `importUmadata`関数
   - `row.length >= 50` → `row.length >= 43`
   - horse_mark_2〜horse_mark_8のマッピングを削除
   
2. **`drizzle/schema.ts`**: スキーマ定義
   - 馬印列は残しても問題なし（NULLが入るだけ）
   
3. **`scripts/create-umadata-table.ts`**: テーブル作成
   - 既存テーブルはそのまま使用可能

## 7. 互換性の注意点

### 7.1 影響のない部分（確認済み）

- 時計比較ロジック（finish_time使用）
- 馬場状態判定（track_condition使用）
- コース適性判定
- 着順・人気データ
- 俺AI分析（saga-brain.ts）

### 7.2 馬印列の使用状況

**使用箇所を確認した結果：**
- ❌ 分析ロジックでの使用: **なし**
- ❌ 表示・UIでの使用: **なし**
- ⚠️ インポート処理での定義: **あり**（削除可能）
- ⚠️ データベーススキーマでの定義: **あり**（残しても問題なし）

**結論**: 馬印列（horse_mark_2〜8）は実際のアプリケーションロジックで使用されていないため、**CSV形式変更による影響なし**

### 7.3 work_1s列の変更

**現在:**
- 既存データは空または不明な値

**新形式:**
- ラップタイムが格納される: `"12.3-10.5-11.8-12.1-12.4-12.6"`

**注意点:**
- 新旧データが混在する可能性あり
- ラップタイム解析時は、`-`区切りの有効なラップデータかどうかをチェックすること

## 8. 関連ファイル

| ファイル | 役割 |
|----------|------|
| `app/api/upload-csv/route.ts` | CSVインポート処理 |
| `drizzle/schema.ts` | DBスキーマ定義 |
| `scripts/create-umadata-table.ts` | テーブル作成スクリプト |
| `lib/saga-ai/saga-brain.ts` | 俺AI分析ロジック |
| `lib/saga-ai/lap-analyzer.ts` | ラップ分析モジュール |

---

## 9. 歴代比較機能（実装済み）

### 9.1 概要

過去の勝ちレースのラップを、同条件の歴代データと比較して「歴代〇位」を算出する機能。

### 9.2 比較条件

以下がすべて一致するレースのみ比較対象:
- **コース**: 同じ競馬場（例: 東京、中山）
- **距離**: 完全一致（例: 芝1600）
- **クラス**: 同じクラスレベル（新馬、未勝利、1勝クラス等）
- **馬場状態**: 同じ状態（良/稍重/重/不良）

### 9.3 判定ロジック

```
1. 過去走が1着 & ラップデータありの場合のみ実行
2. 同条件の過去勝ち馬を最大200件取得
3. 後半4F/5Fを計算してソート
4. 現在のレースの順位を算出
5. トップ10%以内（かつ最低5件以上）→ ハイレベル判定
```

### 9.4 出力形式

**俺AIの【ラップ評価】に表示:**

```
🏆歴代上位: 前走後半4F 44.0秒は新馬戦東京芝1800mで歴代3位/45レース中
```

### 9.5 スコア調整

| 条件 | スコア調整 |
|------|-----------|
| 歴代トップ10%以内 | +5pt（減衰あり） |

減衰係数:
- 1〜3走前: ×1.0
- 4走前: ×0.7
- 5走前: ×0.5

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-11 | 歴代比較機能の実装 |
| 2026-01-11 | 初版作成 - 新CSV形式の仕様とラップ判定プロジェクト計画 |


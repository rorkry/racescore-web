# データの扱いと指数まとめ

最終更新: 2025年12月20日

---

## 1. データソース

### 1.1 使用するCSVファイル

| ファイル名 | 用途 | 保存先 |
|------------|------|--------|
| **merged-indices.csv** | 全指数の統合ファイル（メイン） | アップロード先 |
| **umadata.csv** | 過去走データ | アップロード先 |
| **wakujun.csv** | 出馬表データ | アップロード先 |
| **巻き返し指数作成用.csv** | 巻き返し指数計算用の元データ | ローカル |

### 1.2 merged-indices.csvの列構成

| 列 | 列名 | 説明 | 範囲 |
|----|------|------|------|
| A | race_id | レースID（18桁） | - |
| B | L4F | ラスト4ハロン指数 | 10.7〜106.2 |
| C | T2F | トップ2ハロン指数 | -13.6〜36.4 |
| D | potential | ポテンシャル指数 | 0.0〜9.2 |
| E | revouma | レボウマ指数 | -3.2〜12.4 |
| F | makikaeshi | 巻き返し指数 | 0.0〜10.0 |
| G | cushion | クッション値 | 6.8〜11.3 |

### 1.3 race_idのフォーマット（18桁）

```
202512140605041201
├─ 20251214: 日付（YYYYMMDD）
├─ 06: 場所コード
├─ 05: 開催
├─ 04: 日
├─ 12: レース番号
└─ 01: 馬番（2桁ゼロ埋め）
```

**場所コード:**
| コード | 場所 |
|--------|------|
| 01 | 札幌 |
| 02 | 函館 |
| 03 | 福島 |
| 04 | 新潟 |
| 05 | 東京 |
| 06 | 中山 |
| 07 | 中京 |
| 08 | 京都 |
| 09 | 阪神 |
| 10 | 小倉 |

---

## 2. 各指数の説明

### 2.1 巻き返し指数（makikaeshi）

**概要:** 展開・バイアスに逆らって好走した馬を評価する指数

**範囲:** 0.0〜10.0

**計算ロジック（makikaeshi4.py）:**

| ファクター | 範囲 | 備考 |
|------------|------|------|
| 今回レースレベル（基礎点） | 40〜80点 | A:80, B:70, C:60, D:50, E:40 |
| 位置取り（先行/後方） | -15〜+15点 | なだらか評価 |
| コース取り（内/外） | -15〜+15点 | なだらか評価 |
| 枠番 | -10〜+10点 | なだらか評価 |
| 二重苦ボーナス | ×1.2 | 着差0.5以内限定 |
| 枠×コース取りボーナス | ×1.2 | 着差0.5以内限定 |
| 不利加点上限 | 50点 | キャップ |
| 着差 | -5〜-60点 | なだらか＋大敗緩和 |
| 前走レースレベル | -1.5〜+5点 | A〜E |
| クラス補正 | 0〜+4.5点 | 新馬〜G1 |
| PCI補正 | 0〜+5点 | 強化版 |
| 人気補正 | -8〜0点 | 10番人気以上で減点 |
| D・E抑制 | ×0.6 | 不利加点のみ |

**正規化:** RawScore 40〜100 → 指数 0.0〜10.0

**保存先:** `C:\競馬データ\巻き返し指数\{西暦}\`

### 2.2 ポテンシャル指数（potential）

**概要:** 馬の潜在能力を評価する指数

**範囲:** 0.0〜10.0程度

**解釈:**
- 1 = 未勝利突破級
- 2 = 1勝クラス突破級
- 3 = 2勝クラス突破級
- 4 = 3勝クラス突破級
- 5以上 = OP〜重賞級

**特徴:**
- 未勝利戦では0〜1程度が多い
- 上のクラスで3〜4が出る

### 2.3 L4F（ラスト4ハロン指数）

**概要:** ラスト4ハロン（800m）の走破能力を評価

**範囲:** 10.7〜106.2（平均49.2）

### 2.4 T2F（トップ2ハロン指数）

**概要:** 上がり2ハロン（400m）の走破能力を評価

**範囲:** -13.6〜36.4

### 2.5 レボウマ指数（revouma）

**概要:** 独自の評価指数

**範囲:** -3.2〜12.4

### 2.6 クッション値（cushion）

**概要:** 馬場のクッション値

**範囲:** 6.8〜11.3（平均9.3）

---

## 3. 競うスコアの計算式

### 3.1 配点（100点満点）

| 要素 | 配点 | 計算方法 |
|------|------|----------|
| **巻き返し指数** | 50点 | 前走35点 + 2走前10点 + 3走前5点 |
| **ポテンシャル指数** | 15点 | 直近3走平均12点 + ボーナス最大3点 |
| **着順スコア** | 10点 | `10 - (着順-1)` |
| **着差スコア** | 10点 | `10 - 着差×3` |
| **クラスタタイムスコア** | 8点 | 仮実装（固定4点） |
| **通過順位×ペース** | 7点 | 先行有利度×ペース補正 |

### 3.2 巻き返し指数スコア（50点満点）

```
前走: (makikaeshi / 10) × 35点
2走前: (makikaeshi / 10) × 10点
3走前: (makikaeshi / 10) × 5点
```

### 3.3 ポテンシャル指数スコア（15点満点）

**基本点（12点満点）:**
```
直近3走の平均値 / 10 × 12点
```

**ボーナス（最大3点）:**
```
平均3.0以上: +0.5点
平均4.0以上: +1.0点
平均5.0以上: +1.5点
平均6.0以上: +2.0点
平均7.0以上: +2.5点
平均8.0以上: +3.0点
```

### 3.4 着順スコア（10点満点）

```
1着 → 10点
2着 → 9点
3着 → 8点
...
10着以下 → 0点
```

### 3.5 着差スコア（10点満点）

```
着差0秒 → 10点
着差1秒 → 7点
着差2秒 → 4点
着差3秒以上 → 0点
```

### 3.6 通過順位×ペーススコア（7点満点）

```
basePassScore = (頭数 - 平均通過順位 + 1) / 頭数
passScore = basePassScore × ペース補正 × 7
```

**ペース補正:**
| ペース | 補正値 |
|--------|--------|
| 超ハイ | 1.2 |
| ハイ | 1.1 |
| ミドル | 1.0 |
| スロー | 0.9 |
| 超スロー | 0.8 |

---

## 4. データベーステーブル

### 4.1 indicesテーブル

```sql
CREATE TABLE indices (
  race_id TEXT PRIMARY KEY,
  L4F REAL,
  T2F REAL,
  potential REAL,
  revouma REAL,
  makikaeshi REAL,
  cushion REAL
);
```

### 4.2 umadataテーブル

過去走データを格納。主要カラム:
- race_id_new_no_horse_num: レースID（16桁、馬番なし）
- horse_name: 馬名
- horse_number: 馬番
- finish_position: 着順
- margin: 着差
- corner_2, corner_3, corner_4: 通過順位
- number_of_horses: 頭数
- pci: PCI

### 4.3 wakujunテーブル

出馬表データを格納。主要カラム:
- date: 日付
- place: 場所
- race_number: レース番号
- umaban: 馬番
- umamei: 馬名

---

## 5. データの紐づけ

### 5.1 indices ↔ umadata の紐づけ

```
indicesのrace_id = umadataのrace_id_new_no_horse_num + 馬番(2桁ゼロ埋め)
```

**例:**
- umadata: race_id_new_no_horse_num = `2025121406050412`, horse_number = `1`
- indices: race_id = `202512140605041201`

### 5.2 過去走データの取得

1. wakujunから馬名を取得
2. umadataから馬名で過去走を検索
3. 各過去走に対してindicesからrace_idで指数を取得

---

## 6. 今後の拡張予定

### 6.1 未使用の指数

現在、競うスコアで使用していない指数:
- L4F
- T2F
- レボウマ
- クッション値

### 6.2 クラスタタイムスコア

現在は仮実装（固定4点）。将来的に詳細化予定。

### 6.3 距離補正

巻き返し指数に距離補正を追加する余地あり（短距離では枠番の影響が大きい）。

---

## 7. バージョン履歴

| バージョン | 日付 | 内容 |
|------------|------|------|
| v1.0 | - | 初期実装 |
| v1.1 | - | 指数表示機能追加 |
| v1.2 | - | 6種類の指数表示対応 |
| v1.3 | 2025/12/20 | PDF出力の日本語対応 |
| v1.4 | 2025/12/20 | 競うスコア計算改良（indices連携修正） |

# 過去走が1件しか表示されない問題 - 解決完了

## 🎉 問題解決

### 根本原因

**umadataテーブルに誤ったUNIQUE INDEXが設定されていた**

```sql
CREATE UNIQUE INDEX idx_umadata_race_id ON umadata(race_id_new_no_horse_num)
```

### 問題の詳細

1. **race_id_new_no_horse_numの仕様**
   - CSVの列名: `レースID(新/馬番無)`
   - **馬番を含まない**レースID
   - 例: `2025122106050612` (同じレースの全馬で同じID)

2. **UNIQUE制約の影響**
   - 同じレースIDは1回しか挿入できない
   - 結果: 各レースで最初の1頭のデータのみ保存される
   - 残りの馬のデータはUNIQUE制約エラーでスキップされる

3. **データの欠落**
   - CSVファイル: 47,180行
   - DBに保存されたデータ: 3,407件（7.2%のみ！）
   - 欠落: 43,772件（92.8%）

## 🔧 解決方法

### 実施した修正

```javascript
// 1. UNIQUE INDEXを削除
db.prepare('DROP INDEX IF EXISTS idx_umadata_race_id').run();

// 2. 既存データを削除
db.prepare('DELETE FROM umadata').run();

// 3. 全データを再インポート（47,179件）

// 4. 検索用インデックスを作成（UNIQUEではない）
db.prepare('CREATE INDEX IF NOT EXISTS idx_umadata_horse_name ON umadata(horse_name)').run();
db.prepare('CREATE INDEX IF NOT EXISTS idx_umadata_date ON umadata(date)').run();
```

## 📊 修正前 vs 修正後

### 修正前
```
総件数: 3,407件
総馬数: 2,676頭
過去走5件以上: 1頭 (0.0%)
平均過去走数: 1.3件/頭

アーレムアレスの過去走: 1件
  - 2025. 7.20 函館 芝1800
```

### 修正後
```
総件数: 47,179件  ← 約14倍に増加！
総馬数: 11,808頭  ← 約4.4倍に増加！
過去走5件以上: 4,399頭 (37.3%)  ← 0.0%から37.3%に改善！
平均過去走数: 4.0件/頭

アーレムアレスの過去走: 3件  ← 全て取得成功！
  1. 2025.11.16 京都 芝2000  ✅
  2. 2025. 9. 6 札幌 芝1800  ✅
  3. 2025. 7.20 函館 芝1800  ✅
```

## 🎯 結果

### 修正により解決された問題

1. ✅ 過去走が1件しか表示されない問題 → **複数件表示されるようになった**
2. ✅ アーレムアレスの過去走が欠落 → **3件全て取得できるようになった**
3. ✅ スコアが「データなし」 → **過去走データが増えたため、スコア計算が正常になった**
4. ✅ データの大幅な欠落 → **全47,179件のデータが正常にインポートされた**

### 副次的な改善

- 検索用インデックスの追加により、クエリパフォーマンスも向上
- `horse_name`と`date`でのインデックスにより、高速な検索が可能に

## 📝 今後の注意点

### UNIQUE制約の使用
- `race_id_new_no_horse_num`は馬番を含まないため、UNIQUE制約は不適切
- 同じレースの複数の馬のデータを保存する場合は、UNIQUE制約を使用しない
- または、複合UNIQUE制約を検討: `UNIQUE(race_id_new_no_horse_num, horse_number)`

### データインポートの確認
- インポート後は必ずデータ件数を確認
- CSVの行数とDBの件数を比較
- 大幅な差異がある場合は、制約やエラーを疑う

## ✅ 完了

ブラウザをリロードして、過去走が複数表示されることを確認してください。














# AI Context for racescore-web

## Project Type
Japanese horse racing betting analysis web application

## Tech Stack
- **Framework**: Next.js 15 (App Router)
- **Language**: TypeScript
- **Styling**: Tailwind CSS
- **Database**: SQLite
- **Deployment**: Vercel
- **PWA**: Enabled

## Project Purpose
Analyze race cards and calculate "Kisou Score" (0-100) to support betting decisions on Japanese horse racing (JRA).

## Key Files

### Frontend
- `app/components/EntryTable.tsx` - Main race card table display
- `app/race/[raceKey]/page.tsx` - Race detail page
- `app/page.tsx` - Home page (race list)

### Backend/Logic
- `utils/getClusterData.ts` - Core scoring logic (Kisou Score calculation)
- `lib/db-new.ts` - Database connection and queries
- `scripts/import-csv-full.mjs` - CSV import script (Shift-JIS â†’ UTF-8)

### Types
- `types/record.ts` - TypeScript type definitions

## Database Schema

### Tables
1. **umadata** - Past race records (~47,000 rows)
   - Race results, finish times, positions, margins, etc.
   
2. **wakujun** - Post position data (~350 rows)
   - Current race entries with post positions
   
3. **indices** - Calculated indices
   - Comeback index (makikaeshi)
   - Potential index

## Scoring System

### Kisou Score (0-100 points)
```
Total 100 points:
â”œâ”€ Comeback Index: 50pts (Previous race: 35, 2nd back: 10, 3rd back: 5)
â”œâ”€ Potential Index: 15pts
â””â”€ Recent Performance: 35pts
   â”œâ”€ Finish position: 10pts
   â”œâ”€ Margin: 10pts
   â”œâ”€ Cluster time: 8pts
   â””â”€ Passing position Ã— Pace: 7pts
```

### Comeback Index (0-10 scale)
- **Race Level influence**: ~78% (very dominant)
- Calculated from: race level (A-E), bias, position, course, margin, etc.
- Normalized: Raw score 40-100 â†’ 0.0-10.0

## Common Tasks

### Development
```bash
# Install dependencies
pnpm install

# Run dev server
pnpm dev

# Build
pnpm build

# Deploy (auto via Vercel)
git push origin main
```

### Data Import
```bash
# Import CSV files (Shift-JIS â†’ UTF-8)
node scripts/import-csv-full.mjs
```

## Important Gotchas

### 1. CSV Encoding
- **Input**: Shift-JIS (Japanese encoding)
- **Must convert to**: UTF-8
- **Use**: `iconv-lite` package
- CSV files: `umadata.csv`, `wakujun1227.csv`

### 2. Race Level Weight
- Race level (A-E) accounts for ~78% of comeback index
- This heavily influences final Kisou Score
- May need adjustment for balanced scoring

### 3. Local Track Handling
- Special logic for local tracks (Oi, Funabashi, Sonoda, etc.)
- Different evaluation criteria vs central tracks (JRA)
- Track level multipliers: 1.0 (high) / 0.85 (mid) / 0.7 (low)

## Development Rules

### 1. Cost-Conscious Approach
- **Spec creation**: Claude (this chat) - FREE
- **Implementation**: Cursor ($20/month) or Aider ($5-10/month)
- **Avoid**: Manus (credit-based, expensive, kills motivation)

### 2. Workflow
```
1. Create spec/template with Claude
2. Implement with Cursor
3. Git push â†’ Vercel auto-deploy
4. Test and iterate
```

### 3. Testing
- Always test with small data samples first
- Verify encoding conversion works correctly
- Check score calculation with known examples

## Current Status

### Completed
- âœ… Core scoring logic
- âœ… CSV import infrastructure
- âœ… Basic UI components
- âœ… PWA support
- âœ… Vercel deployment

### In Progress
- ğŸš§ CSV import with Shift-JIS conversion
- ğŸš§ Score calculation optimization
- ğŸš§ UI/UX improvements

### Planned
- ğŸ“‹ PDF export functionality
- ğŸ“‹ Score history tracking
- ğŸ“‹ Enhanced mobile UX

## Quick References

### File Locations
```
/home/claude/racescore-web/
â”œâ”€â”€ app/              # Next.js App Router
â”œâ”€â”€ scripts/          # Data processing
â”œâ”€â”€ lib/              # Server utilities
â”œâ”€â”€ utils/            # Client utilities
â”œâ”€â”€ types/            # TypeScript types
â””â”€â”€ public/           # Static files
```

### Environment
- Node.js 18+
- pnpm (package manager)
- Database: SQLite (races.db)

## Helpful Commands
```bash
# View project structure
tree -L 2 -I 'node_modules|.next'

# Check CSV encoding
file umadata.csv

# View database tables
sqlite3 races.db ".tables"

# Count records
sqlite3 races.db "SELECT COUNT(*) FROM umadata;"
```

## External Dependencies

- **iconv-lite**: Encoding conversion
- **papaparse**: CSV parsing
- **better-sqlite3**: SQLite operations
- **next**: Framework
- **react**: UI library
- **tailwindcss**: Styling

## Notes for AI Assistants

- User prefers concise, actionable responses
- Focus on practical implementation over theory
- Provide code templates when appropriate
- Consider cost implications in suggestions
- Remember: This is a personal project with budget constraints
```

---

## ğŸ“‹ ä½¿ã„æ–¹

### 1. ä¸Šã®å†…å®¹ã‚’å…¨éƒ¨ã‚³ãƒ”ãƒ¼
```
å…¨é¸æŠ: Ctrl+Aï¼ˆã¾ãŸã¯ Cmd+Aï¼‰
ã‚³ãƒ”ãƒ¼: Ctrl+Cï¼ˆã¾ãŸã¯ Cmd+Cï¼‰
```

### 2. Cursorã«è²¼ã‚Šä»˜ã‘
```
1. Cursor ã§ .ai-context.md ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
2. ãƒšãƒ¼ã‚¹ãƒˆ: Ctrl+Vï¼ˆã¾ãŸã¯ Cmd+Vï¼‰
3. ä¿å­˜: Ctrl+Sï¼ˆã¾ãŸã¯ Cmd+Sï¼‰